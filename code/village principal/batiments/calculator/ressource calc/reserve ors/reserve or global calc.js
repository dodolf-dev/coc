import { reserve_or1_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { reserve_or2_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { reserve_or3_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { reserve_or4_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerTempsTotalreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerTempsTotalreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerTempsTotalreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerTempsTotalreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerTempsRestantreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";    
import { calculerTempsRestantreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerTempsRestantreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerTempsRestantreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerTempsdepuisHDVreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerTempsdepuisHDVreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerTempsdepuisHDVreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerTempsdepuisHDVreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerTempsConstructionParHDVreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerTempsConstructionParHDVreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerTempsConstructionParHDVreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerTempsConstructionParHDVreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerPrixTotalreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerPrixTotalreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerPrixTotalreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerPrixTotalreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerPrixRestantreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerPrixRestantreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerPrixRestantreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerPrixRestantreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerPrixdepuisHDVreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerPrixdepuisHDVreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerPrixdepuisHDVreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerPrixdepuisHDVreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerPrixConstructionParHDVreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerPrixConstructionParHDVreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerPrixConstructionParHDVreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerPrixConstructionParHDVreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerExperienceTotalreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerExperienceTotalreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerExperienceTotalreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerExperienceTotalreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerExperienceRestantreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerExperienceRestantreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerExperienceRestantreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerExperienceRestantreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerExperiencedepuisHDVreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerExperiencedepuisHDVreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerExperiencedepuisHDVreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerExperiencedepuisHDVreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { calculerExperienceConstructionParHDVreserve_or1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or1.calc.js";
import { calculerExperienceConstructionParHDVreserve_or2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or2.calc.js";
import { calculerExperienceConstructionParHDVreserve_or3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or3.calc.js";
import { calculerExperienceConstructionParHDVreserve_or4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reserve ors/reserve or4.calc.js";

import { formatPrix } from "/coc/code/outils/affichge nombre.js";
import { convertirSecondescompact } from "/coc/code/outils/convertisseurtemps.js";

function getHDVLevel() {
    return document.getElementById("hdv").value;
}

function getreserve_orLevel(num) {
    return document.getElementById(`reserve_or${num}`).value;
}

let hdvlevel = getHDVLevel(); // Récupérer le niveau de l'Hôtel de Ville

let reserve_or1level = getreserve_orLevel(1);
let reserve_or2level = getreserve_orLevel(2);
let reserve_or3level = getreserve_orLevel(3);
let reserve_or4level = getreserve_orLevel(4);

let reserve_or1levelmax = reserve_or1_nv_max_hdv(hdvlevel);
let reserve_or2levelmax = reserve_or2_nv_max_hdv(hdvlevel);
let reserve_or3levelmax = reserve_or3_nv_max_hdv(hdvlevel);
let reserve_or4levelmax = reserve_or4_nv_max_hdv(hdvlevel);

export function calculerPourcentageNiveauxreserve_ors() {
    // Niveaux actuels
    const niveauxActuels = [
        Math.min(reserve_or1level, reserve_or1levelmax),
        Math.min(reserve_or2level, reserve_or2levelmax),
        Math.min(reserve_or3level, reserve_or3levelmax),
        Math.min(reserve_or4level, reserve_or4levelmax),
    ];

    // Niveaux max possibles selon HDV
    const niveauxMax = [
        reserve_or1levelmax,
        reserve_or2levelmax,
        reserve_or3levelmax,
        reserve_or4levelmax,
    ];

    // Calcul des totaux
    const totalMax = niveauxMax.reduce((a, b) => a + b, 0);
    const totalActuel = niveauxActuels.reduce((a, b) => a + b, 0);

    if (totalMax === 0) return 0; // Évite la division par zéro

    const progression = (totalActuel / totalMax) * 100;
    return parseFloat(progression.toFixed(2)); // Limite a 2 décimales
}

export function globalcalculertempsRestantreserve_ors() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const reserve_or1level = parseInt(getreserve_orLevel(1), 10);
    const reserve_or2level = parseInt(getreserve_orLevel(2), 10);
    const reserve_or3level = parseInt(getreserve_orLevel(3), 10);
    const reserve_or4level = parseInt(getreserve_orLevel(4), 10);

    const reserve_or1levelmax = reserve_or1_nv_max_hdv(hdvlevel);
    const reserve_or2levelmax = reserve_or2_nv_max_hdv(hdvlevel);
    const reserve_or3levelmax = reserve_or3_nv_max_hdv(hdvlevel);
    const reserve_or4levelmax = reserve_or4_nv_max_hdv(hdvlevel);

    let tempsRestant = 0;
    tempsRestant += calculerTempsRestantreserve_or1(reserve_or1level, reserve_or1levelmax);
    tempsRestant += calculerTempsRestantreserve_or2(reserve_or2level, reserve_or2levelmax);
    tempsRestant += calculerTempsRestantreserve_or3(reserve_or3level, reserve_or3levelmax);
    tempsRestant += calculerTempsRestantreserve_or4(reserve_or4level, reserve_or4levelmax);

    return tempsRestant;
}

export function globalcalculertempsTotalreserve_ors() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsTotalreserve_or1(reserve_or1level);
    tempsTotal += calculerTempsTotalreserve_or2(reserve_or2level);
    tempsTotal += calculerTempsTotalreserve_or3(reserve_or3level);
    tempsTotal += calculerTempsTotalreserve_or4(reserve_or4level);
    return tempsTotal;
}

export function globalcalculertempsdepuisHDVreserve_ors() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsdepuisHDVreserve_or1(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVreserve_or2(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVreserve_or3(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVreserve_or4(hdvlevel);
    return tempsTotal;
}

export function globalcalculertempsConstructionParHDVreserve_ors() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsConstructionParHDVreserve_or1(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVreserve_or2(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVreserve_or3(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVreserve_or4(hdvlevel);
    return tempsTotal;
}

export function barredeprogressiontempsreserve_ors() {
    const tempsTotal = globalcalculertempsTotalreserve_ors();
    const tempsRestant = globalcalculertempsRestantreserve_ors();
    const tempsConstructionHDV = globalcalculertempsConstructionParHDVreserve_ors();

    if (tempsTotal === 0) {
        return 0; // Évite la division par zéro
    }

    if (tempsTotal >= tempsConstructionHDV) {
        const progression = ((tempsTotal - tempsRestant) / tempsTotal) * 100;
        return progression.toFixed(2);
    } else {
        // Ajout d'une tolérance pour éviter des valeurs négatives excessives
        const difference = tempsConstructionHDV - tempsTotal;
        if (difference < 0.01 * tempsConstructionHDV) { // Tolérance de 1%
            return 0; // Considérer comme aucune progression négative
        }
        const retard = (difference / tempsConstructionHDV) * 100;
        return (-retard).toFixed(2);
    }
}

export function globalcalculerPrixTotalreserve_or() {
    let couttotal = 0;
    couttotal += calculerPrixTotalreserve_or1(reserve_or1level);
    couttotal += calculerPrixTotalreserve_or2(reserve_or2level);
    couttotal += calculerPrixTotalreserve_or3(reserve_or3level);
    couttotal += calculerPrixTotalreserve_or4(reserve_or4level);
    return couttotal;
}

export function globalcalculerPrixRestantreserve_or() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const reserve_or1level = parseInt(getreserve_orLevel(1), 10);
    const reserve_or2level = parseInt(getreserve_orLevel(2), 10);
    const reserve_or3level = parseInt(getreserve_orLevel(3), 10);
    const reserve_or4level = parseInt(getreserve_orLevel(4), 10);

    const reserve_or1levelmax = reserve_or1_nv_max_hdv(hdvlevel);
    const reserve_or2levelmax = reserve_or2_nv_max_hdv(hdvlevel);
    const reserve_or3levelmax = reserve_or3_nv_max_hdv(hdvlevel);
    const reserve_or4levelmax = reserve_or4_nv_max_hdv(hdvlevel);

    let coutrestant = 0;
    coutrestant += calculerPrixRestantreserve_or1(reserve_or1level, reserve_or1levelmax);
    coutrestant += calculerPrixRestantreserve_or2(reserve_or2level, reserve_or2levelmax);
    coutrestant += calculerPrixRestantreserve_or3(reserve_or3level, reserve_or3levelmax);
    coutrestant += calculerPrixRestantreserve_or4(reserve_or4level, reserve_or4levelmax);
    return coutrestant;
}

export function globalcalculerPrixdepuisHDVreserve_or() {
    let couttotal = 0;
    couttotal += calculerPrixdepuisHDVreserve_or1(hdvlevel);
    couttotal += calculerPrixdepuisHDVreserve_or2(hdvlevel);
    couttotal += calculerPrixdepuisHDVreserve_or3(hdvlevel);
    couttotal += calculerPrixdepuisHDVreserve_or4(hdvlevel);
    return couttotal;
}

export function globalcalculerPrixConstructionParHDVreserve_or() {
    let couttotal = 0;
    couttotal += calculerPrixConstructionParHDVreserve_or1(hdvlevel);
    couttotal += calculerPrixConstructionParHDVreserve_or2(hdvlevel);
    couttotal += calculerPrixConstructionParHDVreserve_or3(hdvlevel);
    couttotal += calculerPrixConstructionParHDVreserve_or4(hdvlevel);
    return couttotal;
}

export function barredeprogrssionprixreserve_ors () {
    const prixTotal = globalcalculerprixTotalreserve_ors();
    const prixRestant = globalcalculerprixRestantreserve_ors();
    const prixConstructionHDV = globalcalculerprixConstructionParHDVreserve_ors();
    if (prixTotal > prixConstructionHDV) {
        let progression = ((prixTotal - prixRestant) / prixTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((prixConstructionHDV - prixTotal) / prixTotal) * 100;
        return (-retard).toFixed(2);
    }
}


export function globalcalculerExperienceTotalreserve_or() {
    let expTotal = 0;
    expTotal += calculerExperienceTotalreserve_or1(reserve_or1level);
    expTotal += calculerExperienceTotalreserve_or2(reserve_or2level);
    expTotal += calculerExperienceTotalreserve_or3(reserve_or3level);
    expTotal += calculerExperienceTotalreserve_or4(reserve_or4level);
    return expTotal;
}

export function globalcalculerExperienceRestantreserve_or() {
    let exprestant = 0;
    exprestant += calculerExperienceRestantreserve_or1(reserve_or1level, reserve_or1levelmax);
    exprestant += calculerExperienceRestantreserve_or2(reserve_or2level, reserve_or2levelmax);
    exprestant += calculerExperienceRestantreserve_or3(reserve_or3level, reserve_or3levelmax);
    exprestant += calculerExperienceRestantreserve_or4(reserve_or4level, reserve_or4levelmax);
    return exprestant;
}

export function globalcalculerExperiencedepuisHDVreserve_or() {
    let exptotal = 0;
    exptotal += calculerExperiencedepuisHDVreserve_or1(hdvlevel);
    exptotal += calculerExperiencedepuisHDVreserve_or2(hdvlevel);
    exptotal += calculerExperiencedepuisHDVreserve_or3(hdvlevel);
    exptotal += calculerExperiencedepuisHDVreserve_or4(hdvlevel);
    return exptotal;
}

export function globalcalculerExperienceConstructionParHDVreserve_or() {
    let exptotal = 0;
    exptotal += calculerExperienceConstructionParHDVreserve_or1(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVreserve_or2(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVreserve_or3(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVreserve_or4(hdvlevel);
    return exptotal;
}

export function barredeprogressionexpreserve_ors() {
    const expTotal = globalcalculerExperienceTotalreserve_or();
    const expRestant = globalcalculerExperienceRestantreserve_or();
    const expConstructionHDV = globalcalculerExperienceConstructionParHDVreserve_or();
    if (expTotal > expConstructionHDV) {
        let progression = ((expTotal - expRestant) / expTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((expConstructionHDV - expTotal) / expTotal) * 100;
        return (-retard).toFixed(2);
    }
}

// Fonction pour mettre à jour la barre de progression
function updatereserve_orProgress() {
    // Recalculer le niveau de l'Hôtel de Ville
    hdvlevel = getHDVLevel();

    // Recalculer les niveaux des reserve_ors
    reserve_or1level = getreserve_orLevel(1);
    reserve_or2level = getreserve_orLevel(2);
    reserve_or3level = getreserve_orLevel(3);
    reserve_or4level = getreserve_orLevel(4);


    // Recalculer les niveaux maximums des reserve_ors en fonction du niveau HDV
    reserve_or1levelmax = reserve_or1_nv_max_hdv(hdvlevel);
    reserve_or2levelmax = reserve_or2_nv_max_hdv(hdvlevel);
    reserve_or3levelmax = reserve_or3_nv_max_hdv(hdvlevel);
    reserve_or4levelmax = reserve_or4_nv_max_hdv(hdvlevel);
    // Calculer le pourcentage de progression
    const progression = calculerPourcentageNiveauxreserve_ors();

    // Mettre à jour la barre de progression et le texte
    const progressBar = document.getElementById('progress-reserve_ors');
    const progressText = document.getElementById('progress-reserve_ors-value');
    const progressTimeText = document.getElementById('progress-reserve_ors-temps');
    const progressPriceText = document.getElementById('progress-reserve_ors-prix-or');

    if (progressBar && progressText) {
        progressBar.value = progression;
        progressText.textContent = `${progression.toFixed(2)}%`; // Limiter à 2 décimales
    }
    if (progressTimeText) {
        const tempsRestant = globalcalculertempsRestantreserve_ors();
        progressTimeText.innerHTML = `${convertirSecondescompact(tempsRestant)} <img src="/coc/image/général/ressource/temps icone.png" alt="temps" class="icone-ressource">`;
    }
    if (progressPriceText) {
        const prixRestant = globalcalculerPrixRestantreserve_or();
        progressPriceText.innerHTML = `${formatPrix(prixRestant)} <img src="/coc/image/village principal/ressource/elixir village-p.jpg" alt="elixir" class="icone-ressource">`;
    }
}

// Ajouter des écouteurs d'événements pour détecter les changements
document.addEventListener('DOMContentLoaded', () => {
    const reserve_orSelects = [
        document.getElementById('reserve_or1'),
        document.getElementById('reserve_or2'),
        document.getElementById('reserve_or3'),
        document.getElementById('reserve_or4'),
    ];

    // Ajouter un écouteur pour chaque reserve_or
    reserve_orSelects.forEach(select => {
        if (select) {
            select.addEventListener('change', updatereserve_orProgress);
        }
    });

    // Ajouter un écouteur pour le changement du niveau HDV
    const hdvSelect = document.getElementById('hdv');
    if (hdvSelect) {
        hdvSelect.addEventListener('change', updatereserve_orProgress);
    }

    // Initialiser la barre de progression au chargement
    updatereserve_orProgress();
});