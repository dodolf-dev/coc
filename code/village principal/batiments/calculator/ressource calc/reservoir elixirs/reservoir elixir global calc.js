import { reservoir_elixir1_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { reservoir_elixir2_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { reservoir_elixir3_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { reservoir_elixir4_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerTempsTotalreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerTempsTotalreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerTempsTotalreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerTempsTotalreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerTempsRestantreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";    
import { calculerTempsRestantreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerTempsRestantreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerTempsRestantreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerTempsdepuisHDVreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerTempsdepuisHDVreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerTempsdepuisHDVreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerTempsdepuisHDVreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerTempsConstructionParHDVreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerTempsConstructionParHDVreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerTempsConstructionParHDVreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerTempsConstructionParHDVreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerPrixTotalreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerPrixTotalreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerPrixTotalreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerPrixTotalreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerPrixRestantreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerPrixRestantreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerPrixRestantreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerPrixRestantreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerPrixdepuisHDVreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerPrixdepuisHDVreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerPrixdepuisHDVreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerPrixdepuisHDVreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerPrixConstructionParHDVreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerPrixConstructionParHDVreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerPrixConstructionParHDVreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerPrixConstructionParHDVreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerExperienceTotalreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerExperienceTotalreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerExperienceTotalreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerExperienceTotalreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerExperienceRestantreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerExperienceRestantreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerExperienceRestantreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerExperienceRestantreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerExperiencedepuisHDVreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerExperiencedepuisHDVreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerExperiencedepuisHDVreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerExperiencedepuisHDVreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { calculerExperienceConstructionParHDVreservoir_elixir1 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir1.calc.js";
import { calculerExperienceConstructionParHDVreservoir_elixir2 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir2.calc.js";
import { calculerExperienceConstructionParHDVreservoir_elixir3 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir3.calc.js";
import { calculerExperienceConstructionParHDVreservoir_elixir4 } from "/coc/code/village principal/batiments/calculator/ressource calc/reservoir elixirs/reservoir elixir4.calc.js";

import { formatPrix } from "/coc/code/outils/affichge nombre.js";
import { convertirSecondescompact } from "/coc/code/outils/convertisseurtemps.js";

function getHDVLevel() {
    return document.getElementById("hdv").value;
}

function getreservoir_elixirLevel(num) {
    return document.getElementById(`reservoir_elixir${num}`).value;
}

let hdvlevel = getHDVLevel(); // Récupérer le niveau de l'Hôtel de Ville

let reservoir_elixir1level = getreservoir_elixirLevel(1);
let reservoir_elixir2level = getreservoir_elixirLevel(2);
let reservoir_elixir3level = getreservoir_elixirLevel(3);
let reservoir_elixir4level = getreservoir_elixirLevel(4);

let reservoir_elixir1levelmax = reservoir_elixir1_nv_max_hdv(hdvlevel);
let reservoir_elixir2levelmax = reservoir_elixir2_nv_max_hdv(hdvlevel);
let reservoir_elixir3levelmax = reservoir_elixir3_nv_max_hdv(hdvlevel);
let reservoir_elixir4levelmax = reservoir_elixir4_nv_max_hdv(hdvlevel);

export function calculerPourcentageNiveauxreservoir_elixirs() {
    // Niveaux actuels
    const niveauxActuels = [
        Math.min(reservoir_elixir1level, reservoir_elixir1levelmax),
        Math.min(reservoir_elixir2level, reservoir_elixir2levelmax),
        Math.min(reservoir_elixir3level, reservoir_elixir3levelmax),
        Math.min(reservoir_elixir4level, reservoir_elixir4levelmax),
    ];

    // Niveaux max possibles selon HDV
    const niveauxMax = [
        reservoir_elixir1levelmax,
        reservoir_elixir2levelmax,
        reservoir_elixir3levelmax,
        reservoir_elixir4levelmax,
    ];

    // Calcul des totaux
    const totalMax = niveauxMax.reduce((a, b) => a + b, 0);
    const totalActuel = niveauxActuels.reduce((a, b) => a + b, 0);

    if (totalMax === 0) return 0; // Évite la division par zéro

    const progression = (totalActuel / totalMax) * 100;
    return parseFloat(progression.toFixed(2)); // Limite a 2 décimales
}

export function globalcalculertempsRestantreservoir_elixirs() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const reservoir_elixir1level = parseInt(getreservoir_elixirLevel(1), 10);
    const reservoir_elixir2level = parseInt(getreservoir_elixirLevel(2), 10);
    const reservoir_elixir3level = parseInt(getreservoir_elixirLevel(3), 10);
    const reservoir_elixir4level = parseInt(getreservoir_elixirLevel(4), 10);

    const reservoir_elixir1levelmax = reservoir_elixir1_nv_max_hdv(hdvlevel);
    const reservoir_elixir2levelmax = reservoir_elixir2_nv_max_hdv(hdvlevel);
    const reservoir_elixir3levelmax = reservoir_elixir3_nv_max_hdv(hdvlevel);
    const reservoir_elixir4levelmax = reservoir_elixir4_nv_max_hdv(hdvlevel);

    let tempsRestant = 0;
    tempsRestant += calculerTempsRestantreservoir_elixir1(reservoir_elixir1level, reservoir_elixir1levelmax);
    tempsRestant += calculerTempsRestantreservoir_elixir2(reservoir_elixir2level, reservoir_elixir2levelmax);
    tempsRestant += calculerTempsRestantreservoir_elixir3(reservoir_elixir3level, reservoir_elixir3levelmax);
    tempsRestant += calculerTempsRestantreservoir_elixir4(reservoir_elixir4level, reservoir_elixir4levelmax);

    return tempsRestant;
}

export function globalcalculertempsTotalreservoir_elixirs() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsTotalreservoir_elixir1(reservoir_elixir1level);
    tempsTotal += calculerTempsTotalreservoir_elixir2(reservoir_elixir2level);
    tempsTotal += calculerTempsTotalreservoir_elixir3(reservoir_elixir3level);
    tempsTotal += calculerTempsTotalreservoir_elixir4(reservoir_elixir4level);
    return tempsTotal;
}

export function globalcalculertempsdepuisHDVreservoir_elixirs() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsdepuisHDVreservoir_elixir1(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVreservoir_elixir2(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVreservoir_elixir3(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVreservoir_elixir4(hdvlevel);
    return tempsTotal;
}

export function globalcalculertempsConstructionParHDVreservoir_elixirs() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsConstructionParHDVreservoir_elixir1(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVreservoir_elixir2(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVreservoir_elixir3(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVreservoir_elixir4(hdvlevel);
    return tempsTotal;
}

export function barredeprogressiontempsreservoir_elixirs() {
    const tempsTotal = globalcalculertempsTotalreservoir_elixirs();
    const tempsRestant = globalcalculertempsRestantreservoir_elixirs();
    const tempsConstructionHDV = globalcalculertempsConstructionParHDVreservoir_elixirs();

    if (tempsTotal === 0) {
        return 0; // Évite la division par zéro
    }

    if (tempsTotal >= tempsConstructionHDV) {
        const progression = ((tempsTotal - tempsRestant) / tempsTotal) * 100;
        return progression.toFixed(2);
    } else {
        // Ajout d'une tolérance pour éviter des valeurs négatives excessives
        const difference = tempsConstructionHDV - tempsTotal;
        if (difference < 0.01 * tempsConstructionHDV) { // Tolérance de 1%
            return 0; // Considérer comme aucune progression négative
        }
        const retard = (difference / tempsConstructionHDV) * 100;
        return (-retard).toFixed(2);
    }
}

export function globalcalculerPrixTotalreservoir_elixir() {
    let couttotal = 0;
    couttotal += calculerPrixTotalreservoir_elixir1(reservoir_elixir1level);
    couttotal += calculerPrixTotalreservoir_elixir2(reservoir_elixir2level);
    couttotal += calculerPrixTotalreservoir_elixir3(reservoir_elixir3level);
    couttotal += calculerPrixTotalreservoir_elixir4(reservoir_elixir4level);
    return couttotal;
}

export function globalcalculerPrixRestantreservoir_elixir() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const reservoir_elixir1level = parseInt(getreservoir_elixirLevel(1), 10);
    const reservoir_elixir2level = parseInt(getreservoir_elixirLevel(2), 10);
    const reservoir_elixir3level = parseInt(getreservoir_elixirLevel(3), 10);
    const reservoir_elixir4level = parseInt(getreservoir_elixirLevel(4), 10);

    const reservoir_elixir1levelmax = reservoir_elixir1_nv_max_hdv(hdvlevel);
    const reservoir_elixir2levelmax = reservoir_elixir2_nv_max_hdv(hdvlevel);
    const reservoir_elixir3levelmax = reservoir_elixir3_nv_max_hdv(hdvlevel);
    const reservoir_elixir4levelmax = reservoir_elixir4_nv_max_hdv(hdvlevel);

    let coutrestant = 0;
    coutrestant += calculerPrixRestantreservoir_elixir1(reservoir_elixir1level, reservoir_elixir1levelmax);
    coutrestant += calculerPrixRestantreservoir_elixir2(reservoir_elixir2level, reservoir_elixir2levelmax);
    coutrestant += calculerPrixRestantreservoir_elixir3(reservoir_elixir3level, reservoir_elixir3levelmax);
    coutrestant += calculerPrixRestantreservoir_elixir4(reservoir_elixir4level, reservoir_elixir4levelmax);
    return coutrestant;
}

export function globalcalculerPrixdepuisHDVreservoir_elixir() {
    let couttotal = 0;
    couttotal += calculerPrixdepuisHDVreservoir_elixir1(hdvlevel);
    couttotal += calculerPrixdepuisHDVreservoir_elixir2(hdvlevel);
    couttotal += calculerPrixdepuisHDVreservoir_elixir3(hdvlevel);
    couttotal += calculerPrixdepuisHDVreservoir_elixir4(hdvlevel);
    return couttotal;
}

export function globalcalculerPrixConstructionParHDVreservoir_elixir() {
    let couttotal = 0;
    couttotal += calculerPrixConstructionParHDVreservoir_elixir1(hdvlevel);
    couttotal += calculerPrixConstructionParHDVreservoir_elixir2(hdvlevel);
    couttotal += calculerPrixConstructionParHDVreservoir_elixir3(hdvlevel);
    couttotal += calculerPrixConstructionParHDVreservoir_elixir4(hdvlevel);
    return couttotal;
}

export function barredeprogrssionprixreservoir_elixirs () {
    const prixTotal = globalcalculerprixTotalreservoir_elixirs();
    const prixRestant = globalcalculerprixRestantreservoir_elixirs();
    const prixConstructionHDV = globalcalculerprixConstructionParHDVreservoir_elixirs();
    if (prixTotal > prixConstructionHDV) {
        let progression = ((prixTotal - prixRestant) / prixTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((prixConstructionHDV - prixTotal) / prixTotal) * 100;
        return (-retard).toFixed(2);
    }
}


export function globalcalculerExperienceTotalreservoir_elixir() {
    let expTotal = 0;
    expTotal += calculerExperienceTotalreservoir_elixir1(reservoir_elixir1level);
    expTotal += calculerExperienceTotalreservoir_elixir2(reservoir_elixir2level);
    expTotal += calculerExperienceTotalreservoir_elixir3(reservoir_elixir3level);
    expTotal += calculerExperienceTotalreservoir_elixir4(reservoir_elixir4level);
    return expTotal;
}

export function globalcalculerExperienceRestantreservoir_elixir() {
    let exprestant = 0;
    exprestant += calculerExperienceRestantreservoir_elixir1(reservoir_elixir1level, reservoir_elixir1levelmax);
    exprestant += calculerExperienceRestantreservoir_elixir2(reservoir_elixir2level, reservoir_elixir2levelmax);
    exprestant += calculerExperienceRestantreservoir_elixir3(reservoir_elixir3level, reservoir_elixir3levelmax);
    exprestant += calculerExperienceRestantreservoir_elixir4(reservoir_elixir4level, reservoir_elixir4levelmax);
    return exprestant;
}

export function globalcalculerExperiencedepuisHDVreservoir_elixir() {
    let exptotal = 0;
    exptotal += calculerExperiencedepuisHDVreservoir_elixir1(hdvlevel);
    exptotal += calculerExperiencedepuisHDVreservoir_elixir2(hdvlevel);
    exptotal += calculerExperiencedepuisHDVreservoir_elixir3(hdvlevel);
    exptotal += calculerExperiencedepuisHDVreservoir_elixir4(hdvlevel);
    return exptotal;
}

export function globalcalculerExperienceConstructionParHDVreservoir_elixir() {
    let exptotal = 0;
    exptotal += calculerExperienceConstructionParHDVreservoir_elixir1(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVreservoir_elixir2(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVreservoir_elixir3(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVreservoir_elixir4(hdvlevel);
    return exptotal;
}

export function barredeprogressionexpreservoir_elixirs() {
    const expTotal = globalcalculerExperienceTotalreservoir_elixir();
    const expRestant = globalcalculerExperienceRestantreservoir_elixir();
    const expConstructionHDV = globalcalculerExperienceConstructionParHDVreservoir_elixir();
    if (expTotal > expConstructionHDV) {
        let progression = ((expTotal - expRestant) / expTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((expConstructionHDV - expTotal) / expTotal) * 100;
        return (-retard).toFixed(2);
    }
}

// Fonction pour mettre à jour la barre de progression
function updatereservoir_elixirProgress() {
    // Recalculer le niveau de l'Hôtel de Ville
    hdvlevel = getHDVLevel();

    // Recalculer les niveaux des reservoir_elixirs
    reservoir_elixir1level = getreservoir_elixirLevel(1);
    reservoir_elixir2level = getreservoir_elixirLevel(2);
    reservoir_elixir3level = getreservoir_elixirLevel(3);
    reservoir_elixir4level = getreservoir_elixirLevel(4);


    // Recalculer les niveaux maximums des reservoir_elixirs en fonction du niveau HDV
    reservoir_elixir1levelmax = reservoir_elixir1_nv_max_hdv(hdvlevel);
    reservoir_elixir2levelmax = reservoir_elixir2_nv_max_hdv(hdvlevel);
    reservoir_elixir3levelmax = reservoir_elixir3_nv_max_hdv(hdvlevel);
    reservoir_elixir4levelmax = reservoir_elixir4_nv_max_hdv(hdvlevel);
    // Calculer le pourcentage de progression
    const progression = calculerPourcentageNiveauxreservoir_elixirs();

    // Mettre à jour la barre de progression et le texte
    const progressBar = document.getElementById('progress-reservoir_elixirs');
    const progressText = document.getElementById('progress-reservoir_elixirs-value');
    const progressTimeText = document.getElementById('progress-reservoir_elixirs-temps');
    const progressPriceText = document.getElementById('progress-reservoir_elixirs-prix-or');

    if (progressBar && progressText) {
        progressBar.value = progression;
        progressText.textContent = `${progression}%`; // Limiter à 2 décimales
    }
    if (progressTimeText) {
        const tempsRestant = globalcalculertempsRestantreservoir_elixirs();
        progressTimeText.innerHTML = `${convertirSecondescompact(tempsRestant)} <img src="/coc/image/général/ressource/temps icone.png" alt="temps" class="icone-ressource">`;
    }
    if (progressPriceText) {
        const prixRestant = globalcalculerPrixRestantreservoir_elixir();
        progressPriceText.innerHTML = `${formatPrix(prixRestant)} <img src="/coc/image/village principal/ressource/or village-p.jpg" alt="elixir" class="icone-ressource">`;
    }
}

// Ajouter des écouteurs d'événements pour détecter les changements
document.addEventListener('DOMContentLoaded', () => {
    const reservoir_elixirSelects = [
        document.getElementById('reservoir_elixir1'),
        document.getElementById('reservoir_elixir2'),
        document.getElementById('reservoir_elixir3'),
        document.getElementById('reservoir_elixir4'),
    ];

    // Ajouter un écouteur pour chaque reservoir_elixir
    reservoir_elixirSelects.forEach(select => {
        if (select) {
            select.addEventListener('change', updatereservoir_elixirProgress);
        }
    });

    // Ajouter un écouteur pour le changement du niveau HDV
    const hdvSelect = document.getElementById('hdv');
    if (hdvSelect) {
        hdvSelect.addEventListener('change', updatereservoir_elixirProgress);
    }

    // Initialiser la barre de progression au chargement
    updatereservoir_elixirProgress();
});