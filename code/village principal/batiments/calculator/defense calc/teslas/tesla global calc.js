import { tesla1_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { tesla2_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { tesla3_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { tesla4_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { tesla5_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerTempsTotaltesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerTempsTotaltesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerTempsTotaltesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerTempsTotaltesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerTempsTotaltesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerTempsRestanttesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";    
import { calculerTempsRestanttesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerTempsRestanttesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerTempsRestanttesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerTempsRestanttesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerTempsdepuisHDVtesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerTempsdepuisHDVtesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerTempsdepuisHDVtesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerTempsdepuisHDVtesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerTempsdepuisHDVtesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerTempsConstructionParHDVtesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerTempsConstructionParHDVtesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerTempsConstructionParHDVtesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerTempsConstructionParHDVtesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerTempsConstructionParHDVtesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerPrixTotaltesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerPrixTotaltesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerPrixTotaltesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerPrixTotaltesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerPrixTotaltesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerPrixRestanttesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerPrixRestanttesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerPrixRestanttesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerPrixRestanttesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerPrixRestanttesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerPrixdepuisHDVtesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerPrixdepuisHDVtesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerPrixdepuisHDVtesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerPrixdepuisHDVtesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerPrixdepuisHDVtesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerPrixConstructionParHDVtesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerPrixConstructionParHDVtesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerPrixConstructionParHDVtesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerPrixConstructionParHDVtesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerPrixConstructionParHDVtesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerExperienceTotaltesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerExperienceTotaltesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerExperienceTotaltesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerExperienceTotaltesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerExperienceTotaltesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerExperienceRestanttesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerExperienceRestanttesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerExperienceRestanttesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerExperienceRestanttesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerExperienceRestanttesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerExperiencedepuisHDVtesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerExperiencedepuisHDVtesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerExperiencedepuisHDVtesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerExperiencedepuisHDVtesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerExperiencedepuisHDVtesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { calculerExperienceConstructionParHDVtesla1 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla1.calc.js";
import { calculerExperienceConstructionParHDVtesla2 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla2.calc.js";
import { calculerExperienceConstructionParHDVtesla3 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla3.calc.js";
import { calculerExperienceConstructionParHDVtesla4 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla4.calc.js";
import { calculerExperienceConstructionParHDVtesla5 } from "/coc/code/village principal/batiments/calculator/defense calc/teslas/tesla5.calc.js";

import { formatPrix } from "/coc/code/outils/affichge nombre.js";
import { convertirSecondescompact } from "/coc/code/outils/convertisseurtemps.js";

function getHDVLevel() {
    return document.getElementById("hdv").value;
}

function getteslaLevel(num) {
    return document.getElementById(`tesla${num}`).value;
}

let hdvlevel = getHDVLevel(); // Récupérer le niveau de l'Hôtel de Ville

let tesla1level = getteslaLevel(1);
let tesla2level = getteslaLevel(2);
let tesla3level = getteslaLevel(3);
let tesla4level = getteslaLevel(4);
let tesla5level = getteslaLevel(5);

let tesla1levelmax = tesla1_nv_max_hdv(hdvlevel);
let tesla2levelmax = tesla2_nv_max_hdv(hdvlevel);
let tesla3levelmax = tesla3_nv_max_hdv(hdvlevel);
let tesla4levelmax = tesla4_nv_max_hdv(hdvlevel);
let tesla5levelmax = tesla5_nv_max_hdv(hdvlevel);

export function calculerPourcentageNiveauxteslas() {
    // Niveaux actuels
    const niveauxActuels = [
        Math.min(tesla1level, tesla1levelmax),
        Math.min(tesla2level, tesla2levelmax),
        Math.min(tesla3level, tesla3levelmax),
        Math.min(tesla4level, tesla4levelmax),
        Math.min(tesla5level, tesla5levelmax)
    ];

    // Niveaux max possibles selon HDV
    const niveauxMax = [
        tesla1levelmax,
        tesla2levelmax,
        tesla3levelmax,
        tesla4levelmax,
        tesla5levelmax
    ];

    // Calcul des totaux
    const totalMax = niveauxMax.reduce((a, b) => a + b, 0);
    const totalActuel = niveauxActuels.reduce((a, b) => a + b, 0);

    if (totalMax === 0) return 0; // Évite la division par zéro

    const progression = (totalActuel / totalMax) * 100;
    return parseFloat(progression.toFixed(2)); // Limite a 2 décimales
}

export function globalcalculertempsRestantteslas() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const tesla1level = parseInt(getteslaLevel(1), 10);
    const tesla2level = parseInt(getteslaLevel(2), 10);
    const tesla3level = parseInt(getteslaLevel(3), 10);
    const tesla4level = parseInt(getteslaLevel(4), 10);
    const tesla5level = parseInt(getteslaLevel(5), 10);

    const tesla1levelmax = tesla1_nv_max_hdv(hdvlevel);
    const tesla2levelmax = tesla2_nv_max_hdv(hdvlevel);
    const tesla3levelmax = tesla3_nv_max_hdv(hdvlevel);
    const tesla4levelmax = tesla4_nv_max_hdv(hdvlevel);
    const tesla5levelmax = tesla5_nv_max_hdv(hdvlevel);

    let tempsRestant = 0;
    tempsRestant += calculerTempsRestanttesla1(tesla1level, tesla1levelmax);
    tempsRestant += calculerTempsRestanttesla2(tesla2level, tesla2levelmax);
    tempsRestant += calculerTempsRestanttesla3(tesla3level, tesla3levelmax);
    tempsRestant += calculerTempsRestanttesla4(tesla4level, tesla4levelmax);
    tempsRestant += calculerTempsRestanttesla5(tesla5level, tesla5levelmax);

    return tempsRestant;
}

export function globalcalculertempsTotalteslas() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsTotaltesla1(tesla1level);
    tempsTotal += calculerTempsTotaltesla2(tesla2level);
    tempsTotal += calculerTempsTotaltesla3(tesla3level);
    tempsTotal += calculerTempsTotaltesla4(tesla4level);
    tempsTotal += calculerTempsTotaltesla5(tesla5level);
    return tempsTotal;
}

export function globalcalculertempsdepuisHDVteslas() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsdepuisHDVtesla1(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVtesla2(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVtesla3(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVtesla4(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVtesla5(hdvlevel);
    return tempsTotal;
}

export function globalcalculertempsConstructionParHDVteslas() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsConstructionParHDVtesla1(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVtesla2(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVtesla3(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVtesla4(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVtesla5(hdvlevel);
    return tempsTotal;
}

export function barredeprogressiontempsteslas() {
    const tempsTotal = globalcalculertempsTotalteslas();
    const tempsRestant = globalcalculertempsRestantteslas();
    const tempsConstructionHDV = globalcalculertempsConstructionParHDVteslas();

    if (tempsTotal === 0) {
        return 0; // Évite la division par zéro
    }

    if (tempsTotal >= tempsConstructionHDV) {
        const progression = ((tempsTotal - tempsRestant) / tempsTotal) * 100;
        return progression.toFixed(2);
    } else {
        // Ajout d'une tolérance pour éviter des valeurs négatives excessives
        const difference = tempsConstructionHDV - tempsTotal;
        if (difference < 0.01 * tempsConstructionHDV) { // Tolérance de 1%
            return 0; // Considérer comme aucune progression négative
        }
        const retard = (difference / tempsConstructionHDV) * 100;
        return (-retard).toFixed(2);
    }
}

export function globalcalculerPrixTotaltesla() {
    let couttotal = 0;
    couttotal += calculerPrixTotaltesla1(tesla1level);
    couttotal += calculerPrixTotaltesla2(tesla2level);
    couttotal += calculerPrixTotaltesla3(tesla3level);
    couttotal += calculerPrixTotaltesla4(tesla4level);
    couttotal += calculerPrixTotaltesla5(tesla5level);
    return couttotal;
}

export function globalcalculerPrixRestanttesla() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const tesla1level = parseInt(getteslaLevel(1), 10);
    const tesla2level = parseInt(getteslaLevel(2), 10);
    const tesla3level = parseInt(getteslaLevel(3), 10);
    const tesla4level = parseInt(getteslaLevel(4), 10);
    const tesla5level = parseInt(getteslaLevel(5), 10);

    const tesla1levelmax = tesla1_nv_max_hdv(hdvlevel);
    const tesla2levelmax = tesla2_nv_max_hdv(hdvlevel);
    const tesla3levelmax = tesla3_nv_max_hdv(hdvlevel);
    const tesla4levelmax = tesla4_nv_max_hdv(hdvlevel);
    const tesla5levelmax = tesla5_nv_max_hdv(hdvlevel);

    let coutrestant = 0;
    coutrestant += calculerPrixRestanttesla1(tesla1level, tesla1levelmax);
    coutrestant += calculerPrixRestanttesla2(tesla2level, tesla2levelmax);
    coutrestant += calculerPrixRestanttesla3(tesla3level, tesla3levelmax);
    coutrestant += calculerPrixRestanttesla4(tesla4level, tesla4levelmax);
    coutrestant += calculerPrixRestanttesla5(tesla5level, tesla5levelmax);
    return coutrestant;
}

export function globalcalculerPrixdepuisHDVtesla() {
    let couttotal = 0;
    couttotal += calculerPrixdepuisHDVtesla1(hdvlevel);
    couttotal += calculerPrixdepuisHDVtesla2(hdvlevel);
    couttotal += calculerPrixdepuisHDVtesla3(hdvlevel);
    couttotal += calculerPrixdepuisHDVtesla4(hdvlevel);
    couttotal += calculerPrixdepuisHDVtesla5(hdvlevel);
    return couttotal;
}

export function globalcalculerPrixConstructionParHDVtesla() {
    let couttotal = 0;
    couttotal += calculerPrixConstructionParHDVtesla1(hdvlevel);
    couttotal += calculerPrixConstructionParHDVtesla2(hdvlevel);
    couttotal += calculerPrixConstructionParHDVtesla3(hdvlevel);
    couttotal += calculerPrixConstructionParHDVtesla4(hdvlevel);
    couttotal += calculerPrixConstructionParHDVtesla5(hdvlevel);
    return couttotal;
}

export function barredeprogrssionprixteslas () {
    const prixTotal = globalcalculerprixTotalteslas();
    const prixRestant = globalcalculerprixRestantteslas();
    const prixConstructionHDV = globalcalculerprixConstructionParHDVteslas();
    if (prixTotal > prixConstructionHDV) {
        let progression = ((prixTotal - prixRestant) / prixTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((prixConstructionHDV - prixTotal) / prixTotal) * 100;
        return (-retard).toFixed(2);
    }
}


export function globalcalculerExperienceTotaltesla() {
    let expTotal = 0;
    expTotal += calculerExperienceTotaltesla1(tesla1level);
    expTotal += calculerExperienceTotaltesla2(tesla2level);
    expTotal += calculerExperienceTotaltesla3(tesla3level);
    expTotal += calculerExperienceTotaltesla4(tesla4level);
    expTotal += calculerExperienceTotaltesla5(tesla5level);
    return expTotal;
}

export function globalcalculerExperienceRestanttesla() {
    let exprestant = 0;
    exprestant += calculerExperienceRestanttesla1(tesla1level, tesla1levelmax);
    exprestant += calculerExperienceRestanttesla2(tesla2level, tesla2levelmax);
    exprestant += calculerExperienceRestanttesla3(tesla3level, tesla3levelmax);
    exprestant += calculerExperienceRestanttesla4(tesla4level, tesla4levelmax);
    exprestant += calculerExperienceRestanttesla5(tesla5level, tesla5levelmax);
    return exprestant;
}

export function globalcalculerExperiencedepuisHDVtesla() {
    let exptotal = 0;
    exptotal += calculerExperiencedepuisHDVtesla1(hdvlevel);
    exptotal += calculerExperiencedepuisHDVtesla2(hdvlevel);
    exptotal += calculerExperiencedepuisHDVtesla3(hdvlevel);
    exptotal += calculerExperiencedepuisHDVtesla4(hdvlevel);
    exptotal += calculerExperiencedepuisHDVtesla5(hdvlevel);
    return exptotal;
}

export function globalcalculerExperienceConstructionParHDVtesla() {
    let exptotal = 0;
    exptotal += calculerExperienceConstructionParHDVtesla1(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVtesla2(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVtesla3(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVtesla4(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVtesla5(hdvlevel);
    return exptotal;
}

export function barredeprogressionexpteslas() {
    const expTotal = globalcalculerExperienceTotaltesla();
    const expRestant = globalcalculerExperienceRestanttesla();
    const expConstructionHDV = globalcalculerExperienceConstructionParHDVtesla();
    if (expTotal > expConstructionHDV) {
        let progression = ((expTotal - expRestant) / expTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((expConstructionHDV - expTotal) / expTotal) * 100;
        return (-retard).toFixed(2);
    }
}

// Fonction pour mettre à jour la barre de progression
function updateteslaProgress() {
    // Recalculer le niveau de l'Hôtel de Ville
    hdvlevel = getHDVLevel();

    // Recalculer les niveaux des teslas
    tesla1level = getteslaLevel(1);
    tesla2level = getteslaLevel(2);
    tesla3level = getteslaLevel(3);
    tesla4level = getteslaLevel(4);
    tesla5level = getteslaLevel(5);

    // Recalculer les niveaux maximums des teslas en fonction du niveau HDV
    tesla1levelmax = tesla1_nv_max_hdv(hdvlevel);
    tesla2levelmax = tesla2_nv_max_hdv(hdvlevel);
    tesla3levelmax = tesla3_nv_max_hdv(hdvlevel);
    tesla4levelmax = tesla4_nv_max_hdv(hdvlevel);
    tesla5levelmax = tesla5_nv_max_hdv(hdvlevel);
    // Calculer le pourcentage de progression
    const progression = calculerPourcentageNiveauxteslas();

    // Mettre à jour la barre de progression et le texte
    const progressBar = document.getElementById('progress-teslas');
    const progressText = document.getElementById('progress-teslas-value');
    const progressTimeText = document.getElementById('progress-teslas-temps');
    const progressPriceText = document.getElementById('progress-teslas-prix-or');

    if (progressBar && progressText) {
        progressBar.value = progression;
        progressText.textContent = `${progression}%`; // Limiter à 2 décimales
    }
    if (progressTimeText) {
        const tempsRestant = globalcalculertempsRestantteslas();
        progressTimeText.innerHTML = `${convertirSecondescompact(tempsRestant)} <img src="/coc/image/général/ressource/temps icone.png" alt="temps" class="icone-ressource">`;
    }
    if (progressPriceText) {
        const prixRestant = globalcalculerPrixRestanttesla();
        progressPriceText.innerHTML = `${formatPrix(prixRestant)} <img src="/coc/image/village principal/ressource/or village-p.jpg" alt="or" class="icone-ressource">`;
    }
}

// Ajouter des écouteurs d'événements pour détecter les changements
document.addEventListener('DOMContentLoaded', () => {
    const teslaSelects = [
        document.getElementById('tesla1'),
        document.getElementById('tesla2'),
        document.getElementById('tesla3'),
        document.getElementById('tesla4'),
        document.getElementById('tesla5'),
    ];

    // Ajouter un écouteur pour chaque tesla
    teslaSelects.forEach(select => {
        if (select) {
            select.addEventListener('change', updateteslaProgress);
        }
    });

    // Ajouter un écouteur pour le changement du niveau HDV
    const hdvSelect = document.getElementById('hdv');
    if (hdvSelect) {
        hdvSelect.addEventListener('change', updateteslaProgress);
    }

    // Initialiser la barre de progression au chargement
    updateteslaProgress();
});