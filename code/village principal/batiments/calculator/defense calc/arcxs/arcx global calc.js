import { arcx1_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { arcx2_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { arcx3_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { arcx4_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerTempsTotalarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerTempsTotalarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerTempsTotalarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerTempsTotalarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerTempsRestantarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";    
import { calculerTempsRestantarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerTempsRestantarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerTempsRestantarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerTempsdepuisHDVarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerTempsdepuisHDVarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerTempsdepuisHDVarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerTempsdepuisHDVarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerTempsConstructionParHDVarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerTempsConstructionParHDVarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerTempsConstructionParHDVarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerTempsConstructionParHDVarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerPrixTotalarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerPrixTotalarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerPrixTotalarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerPrixTotalarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerPrixRestantarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerPrixRestantarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerPrixRestantarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerPrixRestantarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerPrixdepuisHDVarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerPrixdepuisHDVarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerPrixdepuisHDVarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerPrixdepuisHDVarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerPrixConstructionParHDVarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerPrixConstructionParHDVarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerPrixConstructionParHDVarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerPrixConstructionParHDVarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerExperienceTotalarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerExperienceTotalarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerExperienceTotalarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerExperienceTotalarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerExperienceRestantarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerExperienceRestantarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerExperienceRestantarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerExperienceRestantarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerExperiencedepuisHDVarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerExperiencedepuisHDVarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerExperiencedepuisHDVarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerExperiencedepuisHDVarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { calculerExperienceConstructionParHDVarcx1 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx1.calc.js";
import { calculerExperienceConstructionParHDVarcx2 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx2.calc.js";
import { calculerExperienceConstructionParHDVarcx3 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx3.calc.js";
import { calculerExperienceConstructionParHDVarcx4 } from "/coc/code/village principal/batiments/calculator/defense calc/arcxs/arcx4.calc.js";

import { formatPrix } from "/coc/code/outils/affichge nombre.js";
import { convertirSecondescompact } from "/coc/code/outils/convertisseurtemps.js";

function getHDVLevel() {
    return document.getElementById("hdv").value;
}

function getarcxLevel(num) {
    return document.getElementById(`arcx${num}`).value;
}

let hdvlevel = getHDVLevel(); // Récupérer le niveau de l'Hôtel de Ville

let arcx1level = getarcxLevel(1);
let arcx2level = getarcxLevel(2);
let arcx3level = getarcxLevel(3);
let arcx4level = getarcxLevel(4);

let arcx1levelmax = arcx1_nv_max_hdv(hdvlevel);
let arcx2levelmax = arcx2_nv_max_hdv(hdvlevel);
let arcx3levelmax = arcx3_nv_max_hdv(hdvlevel);
let arcx4levelmax = arcx4_nv_max_hdv(hdvlevel);

export function calculerPourcentageNiveauxarcxs() {
    // Niveaux actuels
    const niveauxActuels = [
        Math.min(arcx1level, arcx1levelmax),
        Math.min(arcx2level, arcx2levelmax),
        Math.min(arcx3level, arcx3levelmax),
        Math.min(arcx4level, arcx4levelmax),
    ];

    // Niveaux max possibles selon HDV
    const niveauxMax = [
        arcx1levelmax,
        arcx2levelmax,
        arcx3levelmax,
        arcx4levelmax,
    ];

    // Calcul des totaux
    const totalMax = niveauxMax.reduce((a, b) => a + b, 0);
    const totalActuel = niveauxActuels.reduce((a, b) => a + b, 0);

    if (totalMax === 0) return 0; // Évite la division par zéro

    const progression = (totalActuel / totalMax) * 100;
    return parseFloat(progression.toFixed(2)); // Limite a 2 décimales
}

export function globalcalculertempsRestantarcxs() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const arcx1level = parseInt(getarcxLevel(1), 10);
    const arcx2level = parseInt(getarcxLevel(2), 10);
    const arcx3level = parseInt(getarcxLevel(3), 10);
    const arcx4level = parseInt(getarcxLevel(4), 10);

    const arcx1levelmax = arcx1_nv_max_hdv(hdvlevel);
    const arcx2levelmax = arcx2_nv_max_hdv(hdvlevel);
    const arcx3levelmax = arcx3_nv_max_hdv(hdvlevel);
    const arcx4levelmax = arcx4_nv_max_hdv(hdvlevel);

    let tempsRestant = 0;
    tempsRestant += calculerTempsRestantarcx1(arcx1level, arcx1levelmax);
    tempsRestant += calculerTempsRestantarcx2(arcx2level, arcx2levelmax);
    tempsRestant += calculerTempsRestantarcx3(arcx3level, arcx3levelmax);
    tempsRestant += calculerTempsRestantarcx4(arcx4level, arcx4levelmax);

    return tempsRestant;
}

export function globalcalculertempsTotalarcxs() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsTotalarcx1(arcx1level);
    tempsTotal += calculerTempsTotalarcx2(arcx2level);
    tempsTotal += calculerTempsTotalarcx3(arcx3level);
    tempsTotal += calculerTempsTotalarcx4(arcx4level);
    return tempsTotal;
}

export function globalcalculertempsdepuisHDVarcxs() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsdepuisHDVarcx1(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVarcx2(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVarcx3(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVarcx4(hdvlevel);
    return tempsTotal;
}

export function globalcalculertempsConstructionParHDVarcxs() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsConstructionParHDVarcx1(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVarcx2(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVarcx3(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVarcx4(hdvlevel);
    return tempsTotal;
}

export function barredeprogressiontempsarcxs() {
    const tempsTotal = globalcalculertempsTotalarcxs();
    const tempsRestant = globalcalculertempsRestantarcxs();
    const tempsConstructionHDV = globalcalculertempsConstructionParHDVarcxs();

    if (tempsTotal === 0) {
        return 0; // Évite la division par zéro
    }

    if (tempsTotal >= tempsConstructionHDV) {
        const progression = ((tempsTotal - tempsRestant) / tempsTotal) * 100;
        return progression.toFixed(2);
    } else {
        // Ajout d'une tolérance pour éviter des valeurs négatives excessives
        const difference = tempsConstructionHDV - tempsTotal;
        if (difference < 0.01 * tempsConstructionHDV) { // Tolérance de 1%
            return 0; // Considérer comme aucune progression négative
        }
        const retard = (difference / tempsConstructionHDV) * 100;
        return (-retard).toFixed(2);
    }
}

export function globalcalculerPrixTotalarcx() {
    let couttotal = 0;
    couttotal += calculerPrixTotalarcx1(arcx1level);
    couttotal += calculerPrixTotalarcx2(arcx2level);
    couttotal += calculerPrixTotalarcx3(arcx3level);
    couttotal += calculerPrixTotalarcx4(arcx4level);
    return couttotal;
}

export function globalcalculerPrixRestantarcx() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const arcx1level = parseInt(getarcxLevel(1), 10);
    const arcx2level = parseInt(getarcxLevel(2), 10);
    const arcx3level = parseInt(getarcxLevel(3), 10);
    const arcx4level = parseInt(getarcxLevel(4), 10);

    const arcx1levelmax = arcx1_nv_max_hdv(hdvlevel);
    const arcx2levelmax = arcx2_nv_max_hdv(hdvlevel);
    const arcx3levelmax = arcx3_nv_max_hdv(hdvlevel);
    const arcx4levelmax = arcx4_nv_max_hdv(hdvlevel);

    let coutrestant = 0;
    coutrestant += calculerPrixRestantarcx1(arcx1level, arcx1levelmax);
    coutrestant += calculerPrixRestantarcx2(arcx2level, arcx2levelmax);
    coutrestant += calculerPrixRestantarcx3(arcx3level, arcx3levelmax);
    coutrestant += calculerPrixRestantarcx4(arcx4level, arcx4levelmax);
    return coutrestant;
}

export function globalcalculerPrixdepuisHDVarcx() {
    let couttotal = 0;
    couttotal += calculerPrixdepuisHDVarcx1(hdvlevel);
    couttotal += calculerPrixdepuisHDVarcx2(hdvlevel);
    couttotal += calculerPrixdepuisHDVarcx3(hdvlevel);
    couttotal += calculerPrixdepuisHDVarcx4(hdvlevel);
    return couttotal;
}

export function globalcalculerPrixConstructionParHDVarcx() {
    let couttotal = 0;
    couttotal += calculerPrixConstructionParHDVarcx1(hdvlevel);
    couttotal += calculerPrixConstructionParHDVarcx2(hdvlevel);
    couttotal += calculerPrixConstructionParHDVarcx3(hdvlevel);
    couttotal += calculerPrixConstructionParHDVarcx4(hdvlevel);
    return couttotal;
}

export function barredeprogrssionprixarcxs () {
    const prixTotal = globalcalculerprixTotalarcxs();
    const prixRestant = globalcalculerprixRestantarcxs();
    const prixConstructionHDV = globalcalculerprixConstructionParHDVarcxs();
    if (prixTotal > prixConstructionHDV) {
        let progression = ((prixTotal - prixRestant) / prixTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((prixConstructionHDV - prixTotal) / prixTotal) * 100;
        return (-retard).toFixed(2);
    }
}


export function globalcalculerExperienceTotalarcx() {
    let expTotal = 0;
    expTotal += calculerExperienceTotalarcx1(arcx1level);
    expTotal += calculerExperienceTotalarcx2(arcx2level);
    expTotal += calculerExperienceTotalarcx3(arcx3level);
    expTotal += calculerExperienceTotalarcx4(arcx4level);
    return expTotal;
}

export function globalcalculerExperienceRestantarcx() {
    let exprestant = 0;
    exprestant += calculerExperienceRestantarcx1(arcx1level, arcx1levelmax);
    exprestant += calculerExperienceRestantarcx2(arcx2level, arcx2levelmax);
    exprestant += calculerExperienceRestantarcx3(arcx3level, arcx3levelmax);
    exprestant += calculerExperienceRestantarcx4(arcx4level, arcx4levelmax);
    return exprestant;
}

export function globalcalculerExperiencedepuisHDVarcx() {
    let exptotal = 0;
    exptotal += calculerExperiencedepuisHDVarcx1(hdvlevel);
    exptotal += calculerExperiencedepuisHDVarcx2(hdvlevel);
    exptotal += calculerExperiencedepuisHDVarcx3(hdvlevel);
    exptotal += calculerExperiencedepuisHDVarcx4(hdvlevel);
    return exptotal;
}

export function globalcalculerExperienceConstructionParHDVarcx() {
    let exptotal = 0;
    exptotal += calculerExperienceConstructionParHDVarcx1(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVarcx2(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVarcx3(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVarcx4(hdvlevel);
    return exptotal;
}

export function barredeprogressionexparcxs() {
    const expTotal = globalcalculerExperienceTotalarcx();
    const expRestant = globalcalculerExperienceRestantarcx();
    const expConstructionHDV = globalcalculerExperienceConstructionParHDVarcx();
    if (expTotal > expConstructionHDV) {
        let progression = ((expTotal - expRestant) / expTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((expConstructionHDV - expTotal) / expTotal) * 100;
        return (-retard).toFixed(2);
    }
}

// Fonction pour mettre à jour la barre de progression
function updatearcxProgress() {
    // Recalculer le niveau de l'Hôtel de Ville
    hdvlevel = getHDVLevel();

    // Recalculer les niveaux des arcxs
    arcx1level = getarcxLevel(1);
    arcx2level = getarcxLevel(2);
    arcx3level = getarcxLevel(3);
    arcx4level = getarcxLevel(4);


    // Recalculer les niveaux maximums des arcxs en fonction du niveau HDV
    arcx1levelmax = arcx1_nv_max_hdv(hdvlevel);
    arcx2levelmax = arcx2_nv_max_hdv(hdvlevel);
    arcx3levelmax = arcx3_nv_max_hdv(hdvlevel);
    arcx4levelmax = arcx4_nv_max_hdv(hdvlevel);
    // Calculer le pourcentage de progression
    const progression = calculerPourcentageNiveauxarcxs();

    // Mettre à jour la barre de progression et le texte
    const progressBar = document.getElementById('progress-arcxs');
    const progressText = document.getElementById('progress-arcxs-value');
    const progressTimeText = document.getElementById('progress-arcxs-temps');
    const progressPriceText = document.getElementById('progress-arcxs-prix-or');

    if (progressBar && progressText) {
        progressBar.value = progression;
        progressText.textContent = `${progression}%`; // Limiter à 2 décimales
    }
    if (progressTimeText) {
        const tempsRestant = globalcalculertempsRestantarcxs();
        progressTimeText.innerHTML = `${convertirSecondescompact(tempsRestant)} <img src="/coc/image/général/ressource/temps icone.png" alt="temps" class="icone-ressource">`;
    }
    if (progressPriceText) {
        const prixRestant = globalcalculerPrixRestantarcx();
        progressPriceText.innerHTML = `${formatPrix(prixRestant)} <img src="/coc/image/village principal/ressource/or village-p.jpg" alt="or" class="icone-ressource">`;
    }
}

// Ajouter des écouteurs d'événements pour détecter les changements
document.addEventListener('DOMContentLoaded', () => {
    const arcxSelects = [
        document.getElementById('arcx1'),
        document.getElementById('arcx2'),
        document.getElementById('arcx3'),
        document.getElementById('arcx4'),
    ];

    // Ajouter un écouteur pour chaque arcx
    arcxSelects.forEach(select => {
        if (select) {
            select.addEventListener('change', updatearcxProgress);
        }
    });

    // Ajouter un écouteur pour le changement du niveau HDV
    const hdvSelect = document.getElementById('hdv');
    if (hdvSelect) {
        hdvSelect.addEventListener('change', updatearcxProgress);
    }

    // Initialiser la barre de progression au chargement
    updatearcxProgress();
});