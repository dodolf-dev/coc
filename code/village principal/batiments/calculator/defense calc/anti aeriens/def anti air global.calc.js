import { def_anti_air1_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { def_anti_air2_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { def_anti_air3_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { def_anti_air4_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerTempsTotaldef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerTempsTotaldef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerTempsTotaldef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerTempsTotaldef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerTempsRestantdef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";    
import { calculerTempsRestantdef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerTempsRestantdef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerTempsRestantdef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerTempsdepuisHDVdef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerTempsdepuisHDVdef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerTempsdepuisHDVdef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerTempsdepuisHDVdef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerTempsConstructionParHDVdef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerTempsConstructionParHDVdef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerTempsConstructionParHDVdef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerTempsConstructionParHDVdef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerPrixTotaldef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerPrixTotaldef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerPrixTotaldef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerPrixTotaldef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerPrixRestantdef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerPrixRestantdef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerPrixRestantdef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerPrixRestantdef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerPrixdepuisHDVdef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerPrixdepuisHDVdef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerPrixdepuisHDVdef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerPrixdepuisHDVdef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerPrixConstructionParHDVdef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerPrixConstructionParHDVdef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerPrixConstructionParHDVdef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerPrixConstructionParHDVdef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerExperienceTotaldef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerExperienceTotaldef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerExperienceTotaldef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerExperienceTotaldef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerExperienceRestantdef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerExperienceRestantdef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerExperienceRestantdef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerExperienceRestantdef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerExperiencedepuisHDVdef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerExperiencedepuisHDVdef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerExperiencedepuisHDVdef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerExperiencedepuisHDVdef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { calculerExperienceConstructionParHDVdef_anti_air1 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air1.calc.js";
import { calculerExperienceConstructionParHDVdef_anti_air2 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air2.calc.js";
import { calculerExperienceConstructionParHDVdef_anti_air3 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air3.calc.js";
import { calculerExperienceConstructionParHDVdef_anti_air4 } from "/coc/code/village principal/batiments/calculator/defense calc/anti aeriens/def anti air4.calc.js";

import { formatPrix } from "/coc/code/outils/affichge nombre.js";
import { convertirSecondescompact } from "/coc/code/outils/convertisseurtemps.js";

function getHDVLevel() {
    return document.getElementById("hdv").value;
}

function getdef_anti_airLevel(num) {
    return document.getElementById(`def_anti_air${num}`).value;
}

let hdvlevel = getHDVLevel(); // Récupérer le niveau de l'Hôtel de Ville

let def_anti_air1level = getdef_anti_airLevel(1);
let def_anti_air2level = getdef_anti_airLevel(2);
let def_anti_air3level = getdef_anti_airLevel(3);
let def_anti_air4level = getdef_anti_airLevel(4);

let def_anti_air1levelmax = def_anti_air1_nv_max_hdv(hdvlevel);
let def_anti_air2levelmax = def_anti_air2_nv_max_hdv(hdvlevel);
let def_anti_air3levelmax = def_anti_air3_nv_max_hdv(hdvlevel);
let def_anti_air4levelmax = def_anti_air4_nv_max_hdv(hdvlevel);

export function calculerPourcentageNiveauxdef_anti_airs() {
    // Niveaux actuels
    const niveauxActuels = [
        Math.min(def_anti_air1level, def_anti_air1levelmax),
        Math.min(def_anti_air2level, def_anti_air2levelmax),
        Math.min(def_anti_air3level, def_anti_air3levelmax),
        Math.min(def_anti_air4level, def_anti_air4levelmax),
    ];

    // Niveaux max possibles selon HDV
    const niveauxMax = [
        def_anti_air1levelmax,
        def_anti_air2levelmax,
        def_anti_air3levelmax,
        def_anti_air4levelmax,
    ];

    // Calcul des totaux
    const totalMax = niveauxMax.reduce((a, b) => a + b, 0);
    const totalActuel = niveauxActuels.reduce((a, b) => a + b, 0);

    if (totalMax === 0) return 0; // Évite la division par zéro

    const progression = (totalActuel / totalMax) * 100;
    return parseFloat(progression.toFixed(2)); // Limite a 2 décimales
}

export function globalcalculertempsRestantdef_anti_airs() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const def_anti_air1level = parseInt(getdef_anti_airLevel(1), 10);
    const def_anti_air2level = parseInt(getdef_anti_airLevel(2), 10);
    const def_anti_air3level = parseInt(getdef_anti_airLevel(3), 10);
    const def_anti_air4level = parseInt(getdef_anti_airLevel(4), 10);

    const def_anti_air1levelmax = def_anti_air1_nv_max_hdv(hdvlevel);
    const def_anti_air2levelmax = def_anti_air2_nv_max_hdv(hdvlevel);
    const def_anti_air3levelmax = def_anti_air3_nv_max_hdv(hdvlevel);
    const def_anti_air4levelmax = def_anti_air4_nv_max_hdv(hdvlevel);

    let tempsRestant = 0;
    tempsRestant += calculerTempsRestantdef_anti_air1(def_anti_air1level, def_anti_air1levelmax);
    tempsRestant += calculerTempsRestantdef_anti_air2(def_anti_air2level, def_anti_air2levelmax);
    tempsRestant += calculerTempsRestantdef_anti_air3(def_anti_air3level, def_anti_air3levelmax);
    tempsRestant += calculerTempsRestantdef_anti_air4(def_anti_air4level, def_anti_air4levelmax);

    return tempsRestant;
}

export function globalcalculertempsTotaldef_anti_airs() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsTotaldef_anti_air1(def_anti_air1level);
    tempsTotal += calculerTempsTotaldef_anti_air2(def_anti_air2level);
    tempsTotal += calculerTempsTotaldef_anti_air3(def_anti_air3level);
    tempsTotal += calculerTempsTotaldef_anti_air4(def_anti_air4level);
    return tempsTotal;
}

export function globalcalculertempsdepuisHDVdef_anti_airs() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsdepuisHDVdef_anti_air1(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVdef_anti_air2(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVdef_anti_air3(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVdef_anti_air4(hdvlevel);
    return tempsTotal;
}

export function globalcalculertempsConstructionParHDVdef_anti_airs() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsConstructionParHDVdef_anti_air1(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVdef_anti_air2(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVdef_anti_air3(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVdef_anti_air4(hdvlevel);
    return tempsTotal;
}

export function barredeprogressiontempsdef_anti_airs() {
    const tempsTotal = globalcalculertempsTotaldef_anti_airs();
    const tempsRestant = globalcalculertempsRestantdef_anti_airs();
    const tempsConstructionHDV = globalcalculertempsConstructionParHDVdef_anti_airs();

    if (tempsTotal === 0) {
        return 0; // Évite la division par zéro
    }

    if (tempsTotal >= tempsConstructionHDV) {
        const progression = ((tempsTotal - tempsRestant) / tempsTotal) * 100;
        return progression.toFixed(2);
    } else {
        // Ajout d'une tolérance pour éviter des valeurs négatives excessives
        const difference = tempsConstructionHDV - tempsTotal;
        if (difference < 0.01 * tempsConstructionHDV) { // Tolérance de 1%
            return 0; // Considérer comme aucune progression négative
        }
        const retard = (difference / tempsConstructionHDV) * 100;
        return (-retard).toFixed(2);
    }
}

export function globalcalculerPrixTotaldef_anti_air() {
    let couttotal = 0;
    couttotal += calculerPrixTotaldef_anti_air1(def_anti_air1level);
    couttotal += calculerPrixTotaldef_anti_air2(def_anti_air2level);
    couttotal += calculerPrixTotaldef_anti_air3(def_anti_air3level);
    couttotal += calculerPrixTotaldef_anti_air4(def_anti_air4level);
    return couttotal;
}

export function globalcalculerPrixRestantdef_anti_air() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const def_anti_air1level = parseInt(getdef_anti_airLevel(1), 10);
    const def_anti_air2level = parseInt(getdef_anti_airLevel(2), 10);
    const def_anti_air3level = parseInt(getdef_anti_airLevel(3), 10);
    const def_anti_air4level = parseInt(getdef_anti_airLevel(4), 10);

    const def_anti_air1levelmax = def_anti_air1_nv_max_hdv(hdvlevel);
    const def_anti_air2levelmax = def_anti_air2_nv_max_hdv(hdvlevel);
    const def_anti_air3levelmax = def_anti_air3_nv_max_hdv(hdvlevel);
    const def_anti_air4levelmax = def_anti_air4_nv_max_hdv(hdvlevel);

    let coutrestant = 0;
    coutrestant += calculerPrixRestantdef_anti_air1(def_anti_air1level, def_anti_air1levelmax);
    coutrestant += calculerPrixRestantdef_anti_air2(def_anti_air2level, def_anti_air2levelmax);
    coutrestant += calculerPrixRestantdef_anti_air3(def_anti_air3level, def_anti_air3levelmax);
    coutrestant += calculerPrixRestantdef_anti_air4(def_anti_air4level, def_anti_air4levelmax);
    return coutrestant;
}

export function globalcalculerPrixdepuisHDVdef_anti_air() {
    let couttotal = 0;
    couttotal += calculerPrixdepuisHDVdef_anti_air1(hdvlevel);
    couttotal += calculerPrixdepuisHDVdef_anti_air2(hdvlevel);
    couttotal += calculerPrixdepuisHDVdef_anti_air3(hdvlevel);
    couttotal += calculerPrixdepuisHDVdef_anti_air4(hdvlevel);
    return couttotal;
}

export function globalcalculerPrixConstructionParHDVdef_anti_air() {
    let couttotal = 0;
    couttotal += calculerPrixConstructionParHDVdef_anti_air1(hdvlevel);
    couttotal += calculerPrixConstructionParHDVdef_anti_air2(hdvlevel);
    couttotal += calculerPrixConstructionParHDVdef_anti_air3(hdvlevel);
    couttotal += calculerPrixConstructionParHDVdef_anti_air4(hdvlevel);
    return couttotal;
}

export function barredeprogrssionprixdef_anti_airs () {
    const prixTotal = globalcalculerprixTotaldef_anti_airs();
    const prixRestant = globalcalculerprixRestantdef_anti_airs();
    const prixConstructionHDV = globalcalculerprixConstructionParHDVdef_anti_airs();
    if (prixTotal > prixConstructionHDV) {
        let progression = ((prixTotal - prixRestant) / prixTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((prixConstructionHDV - prixTotal) / prixTotal) * 100;
        return (-retard).toFixed(2);
    }
}


export function globalcalculerExperienceTotaldef_anti_air() {
    let expTotal = 0;
    expTotal += calculerExperienceTotaldef_anti_air1(def_anti_air1level);
    expTotal += calculerExperienceTotaldef_anti_air2(def_anti_air2level);
    expTotal += calculerExperienceTotaldef_anti_air3(def_anti_air3level);
    expTotal += calculerExperienceTotaldef_anti_air4(def_anti_air4level);
    return expTotal;
}

export function globalcalculerExperienceRestantdef_anti_air() {
    let exprestant = 0;
    exprestant += calculerExperienceRestantdef_anti_air1(def_anti_air1level, def_anti_air1levelmax);
    exprestant += calculerExperienceRestantdef_anti_air2(def_anti_air2level, def_anti_air2levelmax);
    exprestant += calculerExperienceRestantdef_anti_air3(def_anti_air3level, def_anti_air3levelmax);
    exprestant += calculerExperienceRestantdef_anti_air4(def_anti_air4level, def_anti_air4levelmax);
    return exprestant;
}

export function globalcalculerExperiencedepuisHDVdef_anti_air() {
    let exptotal = 0;
    exptotal += calculerExperiencedepuisHDVdef_anti_air1(hdvlevel);
    exptotal += calculerExperiencedepuisHDVdef_anti_air2(hdvlevel);
    exptotal += calculerExperiencedepuisHDVdef_anti_air3(hdvlevel);
    exptotal += calculerExperiencedepuisHDVdef_anti_air4(hdvlevel);
    return exptotal;
}

export function globalcalculerExperienceConstructionParHDVdef_anti_air() {
    let exptotal = 0;
    exptotal += calculerExperienceConstructionParHDVdef_anti_air1(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVdef_anti_air2(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVdef_anti_air3(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVdef_anti_air4(hdvlevel);
    return exptotal;
}

export function barredeprogressionexpdef_anti_airs() {
    const expTotal = globalcalculerExperienceTotaldef_anti_air();
    const expRestant = globalcalculerExperienceRestantdef_anti_air();
    const expConstructionHDV = globalcalculerExperienceConstructionParHDVdef_anti_air();
    if (expTotal > expConstructionHDV) {
        let progression = ((expTotal - expRestant) / expTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((expConstructionHDV - expTotal) / expTotal) * 100;
        return (-retard).toFixed(2);
    }
}

// Fonction pour mettre à jour la barre de progression
function updatedef_anti_airProgress() {
    // Recalculer le niveau de l'Hôtel de Ville
    hdvlevel = getHDVLevel();

    // Recalculer les niveaux des def_anti_airs
    def_anti_air1level = getdef_anti_airLevel(1);
    def_anti_air2level = getdef_anti_airLevel(2);
    def_anti_air3level = getdef_anti_airLevel(3);
    def_anti_air4level = getdef_anti_airLevel(4);


    // Recalculer les niveaux maximums des def_anti_airs en fonction du niveau HDV
    def_anti_air1levelmax = def_anti_air1_nv_max_hdv(hdvlevel);
    def_anti_air2levelmax = def_anti_air2_nv_max_hdv(hdvlevel);
    def_anti_air3levelmax = def_anti_air3_nv_max_hdv(hdvlevel);
    def_anti_air4levelmax = def_anti_air4_nv_max_hdv(hdvlevel);
    // Calculer le pourcentage de progression
    const progression = calculerPourcentageNiveauxdef_anti_airs();

    // Mettre à jour la barre de progression et le texte
    const progressBar = document.getElementById('progress-def_anti_airs');
    const progressText = document.getElementById('progress-def_anti_airs-value');
    const progressTimeText = document.getElementById('progress-def_anti_airs-temps');
    const progressPriceText = document.getElementById('progress-def_anti_airs-prix-or');

    if (progressBar && progressText) {
        progressBar.value = progression;
        progressText.textContent = `${progression.toFixed(2)}%`; // Limiter à 2 décimales
    }
    if (progressTimeText) {
        const tempsRestant = globalcalculertempsRestantdef_anti_airs();
        progressTimeText.innerHTML = `${convertirSecondescompact(tempsRestant)} <img src="/coc/image/général/ressource/temps icone.png" alt="temps" class="icone-ressource">`;
    }
    if (progressPriceText) {
        const prixRestant = globalcalculerPrixRestantdef_anti_air();
        progressPriceText.innerHTML = `${formatPrix(prixRestant)} <img src="/coc/image/village principal/ressource/or village-p.jpg" alt="or" class="icone-ressource">`;
    }
}

// Ajouter des écouteurs d'événements pour détecter les changements
document.addEventListener('DOMContentLoaded', () => {
    const def_anti_airSelects = [
        document.getElementById('def_anti_air1'),
        document.getElementById('def_anti_air2'),
        document.getElementById('def_anti_air3'),
        document.getElementById('def_anti_air4'),
    ];

    // Ajouter un écouteur pour chaque def_anti_air
    def_anti_airSelects.forEach(select => {
        if (select) {
            select.addEventListener('change', updatedef_anti_airProgress);
        }
    });

    // Ajouter un écouteur pour le changement du niveau HDV
    const hdvSelect = document.getElementById('hdv');
    if (hdvSelect) {
        hdvSelect.addEventListener('change', updatedef_anti_airProgress);
    }

    // Initialiser la barre de progression au chargement
    updatedef_anti_airProgress();
});