import { mortier1_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { mortier2_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { mortier3_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { mortier4_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerTempsTotalmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerTempsTotalmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerTempsTotalmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerTempsTotalmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerTempsRestantmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";    
import { calculerTempsRestantmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerTempsRestantmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerTempsRestantmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerTempsdepuisHDVmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerTempsdepuisHDVmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerTempsdepuisHDVmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerTempsdepuisHDVmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerTempsConstructionParHDVmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerTempsConstructionParHDVmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerTempsConstructionParHDVmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerTempsConstructionParHDVmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerPrixTotalmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerPrixTotalmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerPrixTotalmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerPrixTotalmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerPrixRestantmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerPrixRestantmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerPrixRestantmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerPrixRestantmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerPrixdepuisHDVmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerPrixdepuisHDVmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerPrixdepuisHDVmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerPrixdepuisHDVmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerPrixConstructionParHDVmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerPrixConstructionParHDVmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerPrixConstructionParHDVmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerPrixConstructionParHDVmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerExperienceTotalmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerExperienceTotalmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerExperienceTotalmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerExperienceTotalmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerExperienceRestantmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerExperienceRestantmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerExperienceRestantmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerExperienceRestantmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerExperiencedepuisHDVmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerExperiencedepuisHDVmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerExperiencedepuisHDVmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerExperiencedepuisHDVmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { calculerExperienceConstructionParHDVmortier1 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier1.calc.js";
import { calculerExperienceConstructionParHDVmortier2 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier2.calc.js";
import { calculerExperienceConstructionParHDVmortier3 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier3.calc.js";
import { calculerExperienceConstructionParHDVmortier4 } from "/coc/code/village principal/batiments/calculator/defense calc/mortiers/mortier4.calc.js";

import { formatPrix } from "/coc/code/outils/affichge nombre.js";
import { convertirSecondescompact } from "/coc/code/outils/convertisseurtemps.js";

function getHDVLevel() {
    return document.getElementById("hdv").value;
}

function getmortierLevel(num) {
    return document.getElementById(`mortier${num}`).value;
}

let hdvlevel = getHDVLevel(); // Récupérer le niveau de l'Hôtel de Ville

let mortier1level = getmortierLevel(1);
let mortier2level = getmortierLevel(2);
let mortier3level = getmortierLevel(3);
let mortier4level = getmortierLevel(4);

let mortier1levelmax = mortier1_nv_max_hdv(hdvlevel);
let mortier2levelmax = mortier2_nv_max_hdv(hdvlevel);
let mortier3levelmax = mortier3_nv_max_hdv(hdvlevel);
let mortier4levelmax = mortier4_nv_max_hdv(hdvlevel);

export function calculerPourcentageNiveauxmortiers() {
    // Niveaux actuels
    const niveauxActuels = [
        Math.min(mortier1level, mortier1levelmax),
        Math.min(mortier2level, mortier2levelmax),
        Math.min(mortier3level, mortier3levelmax),
        Math.min(mortier4level, mortier4levelmax),
    ];

    // Niveaux max possibles selon HDV
    const niveauxMax = [
        mortier1levelmax,
        mortier2levelmax,
        mortier3levelmax,
        mortier4levelmax,
    ];

    // Calcul des totaux
    const totalMax = niveauxMax.reduce((a, b) => a + b, 0);
    const totalActuel = niveauxActuels.reduce((a, b) => a + b, 0);

    if (totalMax === 0) return 0; // Évite la division par zéro

    const progression = (totalActuel / totalMax) * 100;
    return parseFloat(progression.toFixed(2)); // Limite a 2 décimales
}

export function globalcalculertempsRestantmortiers() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const mortier1level = parseInt(getmortierLevel(1), 10);
    const mortier2level = parseInt(getmortierLevel(2), 10);
    const mortier3level = parseInt(getmortierLevel(3), 10);
    const mortier4level = parseInt(getmortierLevel(4), 10);

    const mortier1levelmax = mortier1_nv_max_hdv(hdvlevel);
    const mortier2levelmax = mortier2_nv_max_hdv(hdvlevel);
    const mortier3levelmax = mortier3_nv_max_hdv(hdvlevel);
    const mortier4levelmax = mortier4_nv_max_hdv(hdvlevel);

    let tempsRestant = 0;
    tempsRestant += calculerTempsRestantmortier1(mortier1level, mortier1levelmax);
    tempsRestant += calculerTempsRestantmortier2(mortier2level, mortier2levelmax);
    tempsRestant += calculerTempsRestantmortier3(mortier3level, mortier3levelmax);
    tempsRestant += calculerTempsRestantmortier4(mortier4level, mortier4levelmax);

    return tempsRestant;
}

export function globalcalculertempsTotalmortiers() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsTotalmortier1(mortier1level);
    tempsTotal += calculerTempsTotalmortier2(mortier2level);
    tempsTotal += calculerTempsTotalmortier3(mortier3level);
    tempsTotal += calculerTempsTotalmortier4(mortier4level);
    return tempsTotal;
}

export function globalcalculertempsdepuisHDVmortiers() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsdepuisHDVmortier1(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVmortier2(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVmortier3(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVmortier4(hdvlevel);
    return tempsTotal;
}

export function globalcalculertempsConstructionParHDVmortiers() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsConstructionParHDVmortier1(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVmortier2(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVmortier3(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVmortier4(hdvlevel);
    return tempsTotal;
}

export function barredeprogressiontempsmortiers() {
    const tempsTotal = globalcalculertempsTotalmortiers();
    const tempsRestant = globalcalculertempsRestantmortiers();
    const tempsConstructionHDV = globalcalculertempsConstructionParHDVmortiers();

    if (tempsTotal === 0) {
        return 0; // Évite la division par zéro
    }

    if (tempsTotal >= tempsConstructionHDV) {
        const progression = ((tempsTotal - tempsRestant) / tempsTotal) * 100;
        return progression.toFixed(2);
    } else {
        // Ajout d'une tolérance pour éviter des valeurs négatives excessives
        const difference = tempsConstructionHDV - tempsTotal;
        if (difference < 0.01 * tempsConstructionHDV) { // Tolérance de 1%
            return 0; // Considérer comme aucune progression négative
        }
        const retard = (difference / tempsConstructionHDV) * 100;
        return (-retard).toFixed(2);
    }
}

export function globalcalculerPrixTotalmortier() {
    let couttotal = 0;
    couttotal += calculerPrixTotalmortier1(mortier1level);
    couttotal += calculerPrixTotalmortier2(mortier2level);
    couttotal += calculerPrixTotalmortier3(mortier3level);
    couttotal += calculerPrixTotalmortier4(mortier4level);
    return couttotal;
}

export function globalcalculerPrixRestantmortier() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const mortier1level = parseInt(getmortierLevel(1), 10);
    const mortier2level = parseInt(getmortierLevel(2), 10);
    const mortier3level = parseInt(getmortierLevel(3), 10);
    const mortier4level = parseInt(getmortierLevel(4), 10);

    const mortier1levelmax = mortier1_nv_max_hdv(hdvlevel);
    const mortier2levelmax = mortier2_nv_max_hdv(hdvlevel);
    const mortier3levelmax = mortier3_nv_max_hdv(hdvlevel);
    const mortier4levelmax = mortier4_nv_max_hdv(hdvlevel);

    let coutrestant = 0;
    coutrestant += calculerPrixRestantmortier1(mortier1level, mortier1levelmax);
    coutrestant += calculerPrixRestantmortier2(mortier2level, mortier2levelmax);
    coutrestant += calculerPrixRestantmortier3(mortier3level, mortier3levelmax);
    coutrestant += calculerPrixRestantmortier4(mortier4level, mortier4levelmax);
    return coutrestant;
}

export function globalcalculerPrixdepuisHDVmortier() {
    let couttotal = 0;
    couttotal += calculerPrixdepuisHDVmortier1(hdvlevel);
    couttotal += calculerPrixdepuisHDVmortier2(hdvlevel);
    couttotal += calculerPrixdepuisHDVmortier3(hdvlevel);
    couttotal += calculerPrixdepuisHDVmortier4(hdvlevel);
    return couttotal;
}

export function globalcalculerPrixConstructionParHDVmortier() {
    let couttotal = 0;
    couttotal += calculerPrixConstructionParHDVmortier1(hdvlevel);
    couttotal += calculerPrixConstructionParHDVmortier2(hdvlevel);
    couttotal += calculerPrixConstructionParHDVmortier3(hdvlevel);
    couttotal += calculerPrixConstructionParHDVmortier4(hdvlevel);
    return couttotal;
}

export function barredeprogrssionprixmortiers () {
    const prixTotal = globalcalculerprixTotalmortiers();
    const prixRestant = globalcalculerprixRestantmortiers();
    const prixConstructionHDV = globalcalculerprixConstructionParHDVmortiers();
    if (prixTotal > prixConstructionHDV) {
        let progression = ((prixTotal - prixRestant) / prixTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((prixConstructionHDV - prixTotal) / prixTotal) * 100;
        return (-retard).toFixed(2);
    }
}


export function globalcalculerExperienceTotalmortier() {
    let expTotal = 0;
    expTotal += calculerExperienceTotalmortier1(mortier1level);
    expTotal += calculerExperienceTotalmortier2(mortier2level);
    expTotal += calculerExperienceTotalmortier3(mortier3level);
    expTotal += calculerExperienceTotalmortier4(mortier4level);
    return expTotal;
}

export function globalcalculerExperienceRestantmortier() {
    let exprestant = 0;
    exprestant += calculerExperienceRestantmortier1(mortier1level, mortier1levelmax);
    exprestant += calculerExperienceRestantmortier2(mortier2level, mortier2levelmax);
    exprestant += calculerExperienceRestantmortier3(mortier3level, mortier3levelmax);
    exprestant += calculerExperienceRestantmortier4(mortier4level, mortier4levelmax);
    return exprestant;
}

export function globalcalculerExperiencedepuisHDVmortier() {
    let exptotal = 0;
    exptotal += calculerExperiencedepuisHDVmortier1(hdvlevel);
    exptotal += calculerExperiencedepuisHDVmortier2(hdvlevel);
    exptotal += calculerExperiencedepuisHDVmortier3(hdvlevel);
    exptotal += calculerExperiencedepuisHDVmortier4(hdvlevel);
    return exptotal;
}

export function globalcalculerExperienceConstructionParHDVmortier() {
    let exptotal = 0;
    exptotal += calculerExperienceConstructionParHDVmortier1(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVmortier2(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVmortier3(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVmortier4(hdvlevel);
    return exptotal;
}

export function barredeprogressionexpmortiers() {
    const expTotal = globalcalculerExperienceTotalmortier();
    const expRestant = globalcalculerExperienceRestantmortier();
    const expConstructionHDV = globalcalculerExperienceConstructionParHDVmortier();
    if (expTotal > expConstructionHDV) {
        let progression = ((expTotal - expRestant) / expTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((expConstructionHDV - expTotal) / expTotal) * 100;
        return (-retard).toFixed(2);
    }
}

// Fonction pour mettre à jour la barre de progression
function updatemortierProgress() {
    // Recalculer le niveau de l'Hôtel de Ville
    hdvlevel = getHDVLevel();

    // Recalculer les niveaux des mortiers
    mortier1level = getmortierLevel(1);
    mortier2level = getmortierLevel(2);
    mortier3level = getmortierLevel(3);
    mortier4level = getmortierLevel(4);


    // Recalculer les niveaux maximums des mortiers en fonction du niveau HDV
    mortier1levelmax = mortier1_nv_max_hdv(hdvlevel);
    mortier2levelmax = mortier2_nv_max_hdv(hdvlevel);
    mortier3levelmax = mortier3_nv_max_hdv(hdvlevel);
    mortier4levelmax = mortier4_nv_max_hdv(hdvlevel);
    // Calculer le pourcentage de progression
    const progression = calculerPourcentageNiveauxmortiers();

    // Mettre à jour la barre de progression et le texte
    const progressBar = document.getElementById('progress-mortiers');
    const progressText = document.getElementById('progress-mortiers-value');
    const progressTimeText = document.getElementById('progress-mortiers-temps');
    const progressPriceText = document.getElementById('progress-mortiers-prix-or');

    if (progressBar && progressText) {
        progressBar.value = progression;
        progressText.textContent = `${progression.toFixed(2)}%`; // Limiter à 2 décimales
    }
    if (progressTimeText) {
        const tempsRestant = globalcalculertempsRestantmortiers();
        progressTimeText.innerHTML = `${convertirSecondescompact(tempsRestant)} <img src="/coc/image/général/ressource/temps icone.png" alt="temps" class="icone-ressource">`;
    }
    if (progressPriceText) {
        const prixRestant = globalcalculerPrixRestantmortier();
        progressPriceText.innerHTML = `${formatPrix(prixRestant)} <img src="/coc/image/village principal/ressource/or village-p.jpg" alt="or" class="icone-ressource">`;
    }
}

// Ajouter des écouteurs d'événements pour détecter les changements
document.addEventListener('DOMContentLoaded', () => {
    const mortierSelects = [
        document.getElementById('mortier1'),
        document.getElementById('mortier2'),
        document.getElementById('mortier3'),
        document.getElementById('mortier4'),
    ];

    // Ajouter un écouteur pour chaque mortier
    mortierSelects.forEach(select => {
        if (select) {
            select.addEventListener('change', updatemortierProgress);
        }
    });

    // Ajouter un écouteur pour le changement du niveau HDV
    const hdvSelect = document.getElementById('hdv');
    if (hdvSelect) {
        hdvSelect.addEventListener('change', updatemortierProgress);
    }

    // Initialiser la barre de progression au chargement
    updatemortierProgress();
});