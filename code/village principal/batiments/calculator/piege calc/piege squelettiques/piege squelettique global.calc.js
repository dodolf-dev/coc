import { piege_squelettique1_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { piege_squelettique2_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { piege_squelettique3_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { piege_squelettique4_nv_max_hdv } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerTempsTotalpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerTempsTotalpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerTempsTotalpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerTempsTotalpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerTempsRestantpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";    
import { calculerTempsRestantpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerTempsRestantpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerTempsRestantpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerTempsdepuisHDVpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerTempsdepuisHDVpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerTempsdepuisHDVpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerTempsdepuisHDVpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerTempsConstructionParHDVpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerTempsConstructionParHDVpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerTempsConstructionParHDVpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerTempsConstructionParHDVpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerPrixTotalpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerPrixTotalpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerPrixTotalpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerPrixTotalpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerPrixRestantpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerPrixRestantpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerPrixRestantpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerPrixRestantpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerPrixdepuisHDVpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerPrixdepuisHDVpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerPrixdepuisHDVpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerPrixdepuisHDVpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerPrixConstructionParHDVpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerPrixConstructionParHDVpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerPrixConstructionParHDVpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerPrixConstructionParHDVpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerExperienceTotalpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerExperienceTotalpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerExperienceTotalpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerExperienceTotalpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerExperienceRestantpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerExperienceRestantpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerExperienceRestantpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerExperienceRestantpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerExperiencedepuisHDVpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerExperiencedepuisHDVpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerExperiencedepuisHDVpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerExperiencedepuisHDVpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { calculerExperienceConstructionParHDVpiege_squelettique1 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique1.calc.js";
import { calculerExperienceConstructionParHDVpiege_squelettique2 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique2.calc.js";
import { calculerExperienceConstructionParHDVpiege_squelettique3 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique3.calc.js";
import { calculerExperienceConstructionParHDVpiege_squelettique4 } from "/coc/code/village principal/batiments/calculator/piege calc/piege squelettiques/piege squelettique4.calc.js";

import { formatPrix } from "/coc/code/outils/affichge nombre.js";
import { convertirSecondescompact } from "/coc/code/outils/convertisseurtemps.js";

function getHDVLevel() {
    return document.getElementById("hdv").value;
}

function getpiege_squelettiqueLevel(num) {
    return document.getElementById(`piege_squelettique${num}`).value;
}

let hdvlevel = getHDVLevel(); // Récupérer le niveau de l'Hôtel de Ville

let piege_squelettique1level = getpiege_squelettiqueLevel(1);
let piege_squelettique2level = getpiege_squelettiqueLevel(2);
let piege_squelettique3level = getpiege_squelettiqueLevel(3);
let piege_squelettique4level = getpiege_squelettiqueLevel(4);

let piege_squelettique1levelmax = piege_squelettique1_nv_max_hdv(hdvlevel);
let piege_squelettique2levelmax = piege_squelettique2_nv_max_hdv(hdvlevel);
let piege_squelettique3levelmax = piege_squelettique3_nv_max_hdv(hdvlevel);
let piege_squelettique4levelmax = piege_squelettique4_nv_max_hdv(hdvlevel);

export function calculerPourcentageNiveauxpiege_squelettiques() {
    // Niveaux actuels
    const niveauxActuels = [
        Math.min(piege_squelettique1level, piege_squelettique1levelmax),
        Math.min(piege_squelettique2level, piege_squelettique2levelmax),
        Math.min(piege_squelettique3level, piege_squelettique3levelmax),
        Math.min(piege_squelettique4level, piege_squelettique4levelmax),
    ];

    // Niveaux max possibles selon HDV
    const niveauxMax = [
        piege_squelettique1levelmax,
        piege_squelettique2levelmax,
        piege_squelettique3levelmax,
        piege_squelettique4levelmax,
    ];

    // Calcul des totaux
    const totalMax = niveauxMax.reduce((a, b) => a + b, 0);
    const totalActuel = niveauxActuels.reduce((a, b) => a + b, 0);

    if (totalMax === 0) return 0; // Évite la division par zéro

    const progression = (totalActuel / totalMax) * 100;
    return parseFloat(progression.toFixed(2)); // Limite a 2 décimales
}

export function globalcalculertempsRestantpiege_squelettiques() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const piege_squelettique1level = parseInt(getpiege_squelettiqueLevel(1), 10);
    const piege_squelettique2level = parseInt(getpiege_squelettiqueLevel(2), 10);
    const piege_squelettique3level = parseInt(getpiege_squelettiqueLevel(3), 10);
    const piege_squelettique4level = parseInt(getpiege_squelettiqueLevel(4), 10);

    const piege_squelettique1levelmax = piege_squelettique1_nv_max_hdv(hdvlevel);
    const piege_squelettique2levelmax = piege_squelettique2_nv_max_hdv(hdvlevel);
    const piege_squelettique3levelmax = piege_squelettique3_nv_max_hdv(hdvlevel);
    const piege_squelettique4levelmax = piege_squelettique4_nv_max_hdv(hdvlevel);

    let tempsRestant = 0;
    tempsRestant += calculerTempsRestantpiege_squelettique1(piege_squelettique1level, piege_squelettique1levelmax);
    tempsRestant += calculerTempsRestantpiege_squelettique2(piege_squelettique2level, piege_squelettique2levelmax);
    tempsRestant += calculerTempsRestantpiege_squelettique3(piege_squelettique3level, piege_squelettique3levelmax);
    tempsRestant += calculerTempsRestantpiege_squelettique4(piege_squelettique4level, piege_squelettique4levelmax);
    return tempsRestant;
}

export function globalcalculertempsTotalpiege_squelettiques() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsTotalpiege_squelettique1(piege_squelettique1level);
    tempsTotal += calculerTempsTotalpiege_squelettique2(piege_squelettique2level);
    tempsTotal += calculerTempsTotalpiege_squelettique3(piege_squelettique3level);
    tempsTotal += calculerTempsTotalpiege_squelettique4(piege_squelettique4level);
    return tempsTotal;
}

export function globalcalculertempsdepuisHDVpiege_squelettiques() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsdepuisHDVpiege_squelettique1(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVpiege_squelettique2(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVpiege_squelettique3(hdvlevel);
    tempsTotal += calculerTempsdepuisHDVpiege_squelettique4(hdvlevel);
    return tempsTotal;
}

export function globalcalculertempsConstructionParHDVpiege_squelettiques() {
    let tempsTotal = 0;
    tempsTotal += calculerTempsConstructionParHDVpiege_squelettique1(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVpiege_squelettique2(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVpiege_squelettique3(hdvlevel);
    tempsTotal += calculerTempsConstructionParHDVpiege_squelettique4(hdvlevel);
    return tempsTotal;
}

export function barredeprogressiontempspiege_squelettiques() {
    const tempsTotal = globalcalculertempsTotalpiege_squelettiques();
    const tempsRestant = globalcalculertempsRestantpiege_squelettiques();
    const tempsConstructionHDV = globalcalculertempsConstructionParHDVpiege_squelettiques();

    if (tempsTotal === 0) {
        return 0; // Évite la division par zéro
    }

    if (tempsTotal >= tempsConstructionHDV) {
        const progression = ((tempsTotal - tempsRestant) / tempsTotal) * 100;
        return progression.toFixed(2);
    } else {
        // Ajout d'une tolérance pour éviter des valeurs négatives excessives
        const difference = tempsConstructionHDV - tempsTotal;
        if (difference < 0.01 * tempsConstructionHDV) { // Tolérance de 1%
            return 0; // Considérer comme aucune progression négative
        }
        const retard = (difference / tempsConstructionHDV) * 100;
        return (-retard).toFixed(2);
    }
}

export function globalcalculerPrixTotalpiege_squelettique() {
    let couttotal = 0;
    couttotal += calculerPrixTotalpiege_squelettique1(piege_squelettique1level);
    couttotal += calculerPrixTotalpiege_squelettique2(piege_squelettique2level);
    couttotal += calculerPrixTotalpiege_squelettique3(piege_squelettique3level);
    couttotal += calculerPrixTotalpiege_squelettique4(piege_squelettique4level);
    return couttotal;
}

export function globalcalculerPrixRestantpiege_squelettique() {
    const hdvlevel = parseInt(getHDVLevel(), 10);

    const piege_squelettique1level = parseInt(getpiege_squelettiqueLevel(1), 10);
    const piege_squelettique2level = parseInt(getpiege_squelettiqueLevel(2), 10);
    const piege_squelettique3level = parseInt(getpiege_squelettiqueLevel(3), 10);
    const piege_squelettique4level = parseInt(getpiege_squelettiqueLevel(4), 10);

    const piege_squelettique1levelmax = piege_squelettique1_nv_max_hdv(hdvlevel);
    const piege_squelettique2levelmax = piege_squelettique2_nv_max_hdv(hdvlevel);
    const piege_squelettique3levelmax = piege_squelettique3_nv_max_hdv(hdvlevel);
    const piege_squelettique4levelmax = piege_squelettique4_nv_max_hdv(hdvlevel);

    let coutrestant = 0;
    coutrestant += calculerPrixRestantpiege_squelettique1(piege_squelettique1level, piege_squelettique1levelmax);
    coutrestant += calculerPrixRestantpiege_squelettique2(piege_squelettique2level, piege_squelettique2levelmax);
    coutrestant += calculerPrixRestantpiege_squelettique3(piege_squelettique3level, piege_squelettique3levelmax);
    coutrestant += calculerPrixRestantpiege_squelettique4(piege_squelettique4level, piege_squelettique4levelmax);
    return coutrestant;
}

export function globalcalculerPrixdepuisHDVpiege_squelettique() {
    let couttotal = 0;
    couttotal += calculerPrixdepuisHDVpiege_squelettique1(hdvlevel);
    couttotal += calculerPrixdepuisHDVpiege_squelettique2(hdvlevel);
    couttotal += calculerPrixdepuisHDVpiege_squelettique3(hdvlevel);
    couttotal += calculerPrixdepuisHDVpiege_squelettique4(hdvlevel);
    return couttotal;
}

export function globalcalculerPrixConstructionParHDVpiege_squelettique() {
    let couttotal = 0;
    couttotal += calculerPrixConstructionParHDVpiege_squelettique1(hdvlevel);
    couttotal += calculerPrixConstructionParHDVpiege_squelettique2(hdvlevel);
    couttotal += calculerPrixConstructionParHDVpiege_squelettique3(hdvlevel);
    couttotal += calculerPrixConstructionParHDVpiege_squelettique4(hdvlevel);
    return couttotal;
}

export function barredeprogrssionprixpiege_squelettiques () {
    const prixTotal = globalcalculerprixTotalpiege_squelettiques();
    const prixRestant = globalcalculerprixRestantpiege_squelettiques();
    const prixConstructionHDV = globalcalculerprixConstructionParHDVpiege_squelettiques();
    if (prixTotal > prixConstructionHDV) {
        let progression = ((prixTotal - prixRestant) / prixTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((prixConstructionHDV - prixTotal) / prixTotal) * 100;
        return (-retard).toFixed(2);
    }
}


export function globalcalculerExperienceTotalpiege_squelettique() {
    let expTotal = 0;
    expTotal += calculerExperienceTotalpiege_squelettique1(piege_squelettique1level);
    expTotal += calculerExperienceTotalpiege_squelettique2(piege_squelettique2level);
    expTotal += calculerExperienceTotalpiege_squelettique3(piege_squelettique3level);
    expTotal += calculerExperienceTotalpiege_squelettique4(piege_squelettique4level);
    return expTotal;
}

export function globalcalculerExperienceRestantpiege_squelettique() {
    let exprestant = 0;
    exprestant += calculerExperienceRestantpiege_squelettique1(piege_squelettique1level, piege_squelettique1levelmax);
    exprestant += calculerExperienceRestantpiege_squelettique2(piege_squelettique2level, piege_squelettique2levelmax);
    exprestant += calculerExperienceRestantpiege_squelettique3(piege_squelettique3level, piege_squelettique3levelmax);
    exprestant += calculerExperienceRestantpiege_squelettique4(piege_squelettique4level, piege_squelettique4levelmax);
    return exprestant;
}

export function globalcalculerExperiencedepuisHDVpiege_squelettique() {
    let exptotal = 0;
    exptotal += calculerExperiencedepuisHDVpiege_squelettique1(hdvlevel);
    exptotal += calculerExperiencedepuisHDVpiege_squelettique2(hdvlevel);
    exptotal += calculerExperiencedepuisHDVpiege_squelettique3(hdvlevel);
    exptotal += calculerExperiencedepuisHDVpiege_squelettique4(hdvlevel);
    return exptotal;
}

export function globalcalculerExperienceConstructionParHDVpiege_squelettique() {
    let exptotal = 0;
    exptotal += calculerExperienceConstructionParHDVpiege_squelettique1(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVpiege_squelettique2(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVpiege_squelettique3(hdvlevel);
    exptotal += calculerExperienceConstructionParHDVpiege_squelettique4(hdvlevel);
    return exptotal;
}

export function barredeprogressionexppiege_squelettiques() {
    const expTotal = globalcalculerExperienceTotalpiege_squelettique();
    const expRestant = globalcalculerExperienceRestantpiege_squelettique();
    const expConstructionHDV = globalcalculerExperienceConstructionParHDVpiege_squelettique();
    if (expTotal > expConstructionHDV) {
        let progression = ((expTotal - expRestant) / expTotal) * 100;
        return progression.toFixed(2);
    } else {
        let retard = ((expConstructionHDV - expTotal) / expTotal) * 100;
        return (-retard).toFixed(2);
    }
}

// Fonction pour mettre à jour la barre de progression
function updatepiege_squelettiqueProgress() {
    // Recalculer le niveau de l'Hôtel de Ville
    hdvlevel = getHDVLevel();

    // Recalculer les niveaux des piege_squelettiques
    piege_squelettique1level = getpiege_squelettiqueLevel(1);
    piege_squelettique2level = getpiege_squelettiqueLevel(2);
    piege_squelettique3level = getpiege_squelettiqueLevel(3);
    piege_squelettique4level = getpiege_squelettiqueLevel(4);

    // Recalculer les niveaux maximums des piege_squelettiques en fonction du niveau HDV
    piege_squelettique1levelmax = piege_squelettique1_nv_max_hdv(hdvlevel);
    piege_squelettique2levelmax = piege_squelettique2_nv_max_hdv(hdvlevel);
    piege_squelettique3levelmax = piege_squelettique3_nv_max_hdv(hdvlevel);
    piege_squelettique4levelmax = piege_squelettique4_nv_max_hdv(hdvlevel);
    // Calculer le pourcentage de progression
    const progression = calculerPourcentageNiveauxpiege_squelettiques();

    // Mettre à jour la barre de progression et le texte
    const progressBar = document.getElementById('progress-piege_squelettiques');
    const progressText = document.getElementById('progress-piege_squelettiques-value');
    const progressTimeText = document.getElementById('progress-piege_squelettiques-temps');
    const progressPriceText = document.getElementById('progress-piege_squelettiques-prix-or');

    if (progressBar && progressText) {
        progressBar.value = progression;
        progressText.textContent = `${progression.toFixed(2)}%`; // Limiter à 2 décimales
    }
    if (progressTimeText) {
        const tempsRestant = globalcalculertempsRestantpiege_squelettiques();
        if (tempsRestant === 0) {
            progressTimeText.style.display = "none";
        }
        else {
            progressTimeText.style.display = "";
            progressTimeText.innerHTML = `${convertirSecondescompact(tempsRestant)} <img src="/coc/image/général/ressource/temps icone.png" alt="temps" class="icone-ressource">`;
        }
    }
    if (progressPriceText) {
        const prixRestant = globalcalculerPrixRestantpiege_squelettique();
        if (prixRestant === 0){
            progressPriceText.style.display = "none";
        }
        else {
            progressPriceText.style.display = "";
            progressPriceText.innerHTML = `${formatPrix(prixRestant)} <img src="/coc/image/village principal/ressource/or village-p.jpg" alt="or" class="icone-ressource">`;
        }
    }
}

// Ajouter des écouteurs d'événements pour détecter les changements
document.addEventListener('DOMContentLoaded', () => {
    const piege_squelettiqueSelects = [
        document.getElementById('piege_squelettique1'),
        document.getElementById('piege_squelettique2'),
        document.getElementById('piege_squelettique3'),
        document.getElementById('piege_squelettique4'),
    ];

    // Ajouter un écouteur pour chaque piege_squelettique
    piege_squelettiqueSelects.forEach(select => {
        if (select) {
            select.addEventListener('change', updatepiege_squelettiqueProgress);
        }
    });

    // Ajouter un écouteur pour le changement du niveau HDV
    const hdvSelect = document.getElementById('hdv');
    if (hdvSelect) {
        hdvSelect.addEventListener('change', updatepiege_squelettiqueProgress);
    }

    // Initialiser la barre de progression au chargement
    updatepiege_squelettiqueProgress();
});